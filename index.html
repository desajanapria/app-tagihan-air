<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Aplikasi Tagihan Air</title>
    <!-- Tambahkan Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <!-- NEW: Tambahkan Font Awesome CDN untuk Icon -->
    <!-- PERBAIKAN ERROR: Integrity dan Crossorigin dihapus untuk menghindari error digest -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <style>
        :root {
            --primary-color: #007BFF;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #f4f7f6;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--dark-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            width: 95%;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            flex-grow: 1;
        }

        /* --- Global Components --- */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        /* NEW: Button Small Size */
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #bd2130; }
        .btn-block { width: 100%; margin-top: 10px; }
        /* NEW: Minimal Spinner for Buttons (Suggestion 5) */
        .btn .spinner {
            width: 15px;
            height: 15px;
            border-width: 2px !important;
            margin-right: 5px;
            display: inline-block;
            vertical-align: middle;
            border-top-color: currentColor !important; /* Agar warna spinner sesuai warna text tombol */
        }
        .btn[disabled] {
            cursor: not-allowed;
            opacity: 0.8;
        }

        input[type="text"], input[type="number"], input[type="password"], input[type="email"], input[type="date"], input[type="month"], select, textarea {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.05rem rgba(0, 123, 255, 0.25); /* Saran: Efek focus lebih baik */
            outline: none;
        }
        label { margin-top: 10px; display: block; font-weight: 500; }
        
        /* FIX: Tambahkan kelas CSS yang hilang */
        .form-group { margin-bottom: 15px; }
        .form-control-file { border: 1px solid #ccc; padding: 5px; border-radius: 4px; }
        .text-danger { color: var(--danger-color); }
        .text-muted { color: var(--secondary-color); font-size: 0.85em; }

        /* NEW: Alert/Badge untuk Notifikasi di Dashboard */
        .dashboard-alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            font-weight: bold;
            display: none; /* Default hidden */
            align-items: center;
            gap: 10px;
        }
        .dashboard-alert.alert-danger { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .dashboard-alert.alert-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }


        /* --- Layout --- */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: transparent;
            box-shadow: none;
        }
        .header-title {
            margin: 0;
            font-size: 1.5rem;
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }

        .main-content {
            display: flex;
        }
        .sidebar {
            width: 250px;
            padding: 20px 0;
            background-color: var(--light-color);
            border-right: 1px solid #ddd;
            min-height: calc(100vh - 80px); /* Adjust based on header height */
            display: flex; /* Tambahkan untuk footer sidebar */
            flex-direction: column; /* Tambahkan untuk footer sidebar */
        }
        /* UPDATED: CSS untuk ikon di sidebar */
        .sidebar-nav a {
            display: flex; /* Menggunakan flexbox untuk ikon dan teks */
            align-items: center;
            gap: 10px; /* Jarak antara ikon dan teks */
            padding: 12px 20px;
            color: var(--dark-color);
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: background-color 0.3s, border-left-color 0.3s;
        }
        .sidebar-nav a:hover {
            background-color: #e9ecef;
        }
        .sidebar-nav a.active {
            background-color: var(--primary-color);
            color: white;
            border-left-color: var(--success-color);
        }
        /* Optional: Mengatur lebar ikon agar rapi */
        .sidebar-nav a i {
            width: 20px; 
            text-align: center;
        }
        .sidebar-nav a.active i {
             color: white; /* Pastikan ikon tetap putih saat aktif */
        }
        /* END UPDATED CSS */
        
        .sidebar-nav a.hidden-role {
            display: none; /* Menyembunyikan link menu berdasarkan peran */
        }
        .content-area {
            flex-grow: 1;
            padding: 20px;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        h2 {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        /* NEW: Footer Hak Cipta Styles */
        .app-footer-copyright {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 0.75em;
            color: var(--secondary-color);
            text-align: center;
            border-top: 1px solid #ddd;
        }
        .login-card-footer {
            margin-top: 15px;
            font-size: 0.75em;
            color: var(--secondary-color);
        }


        /* --- Dashboard Stats --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
            position: relative; /* Untuk ikon */
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-card .stat-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            opacity: 0.7;
        }
        /* Penyesuaian warna ikon */
        .stat-card[style*="success-color"] .stat-icon { color: var(--success-color); }
        .stat-card[style*="danger-color"] .stat-icon { color: var(--danger-color); }
        
        .stat-card p {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            color: var(--primary-dark);
        }
        /* Style untuk saldo (Kas Umum) */
        .stat-saldo-masuk { border-left-color: var(--success-color); }
        .stat-saldo-keluar { border-left-color: var(--danger-color); }
        .stat-saldo-akhir { border-left-color: var(--primary-color); }

        /* --- Table Styling --- */
        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }
        /* FIX: Tambahkan styling untuk tabel BKU agar terlihat lebih akuntansi */
        #tabel-kas-umum th { background-color: var(--dark-color); }
        #tabel-kas-umum tr:last-child td { border-top: 2px solid var(--primary-color); font-weight: bold; }
        
        /* NEW CSS: Styling untuk baris Saldo Awal di BKU */
        #tabel-kas-umum .saldo-awal-row td {
            border-top: 2px solid var(--dark-color) !important; 
            border-bottom: 2px solid var(--dark-color) !important;
            background-color: #e9ecef !important;
            font-weight: bold;
        }
        /* NEW CSS: Indikator Sorting */
        .table-responsive th[data-sort-desc]:after {
            content: " \25BC"; /* Panah Bawah */
            font-size: 0.7em;
            margin-left: 5px;
            color: white; /* Sesuaikan dengan warna header */
        }
        #tabel-kas-umum th[data-sort-desc]:after {
            color: white; /* Sesuaikan dengan warna header */
        }


        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        /* Saran: Efek hover pada baris tabel */
        table tr:hover:not(:last-child) { 
            background-color: #e3f2fd; 
            cursor: pointer;
        }
        .action-buttons button {
            margin-right: 5px;
        }
        
        /* NEW CSS: Text Truncation for long descriptions/addresses (Saran 3) */
        .truncate-text {
            max-width: 300px; /* Batasi lebar kolom agar pemotongan efektif */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* NEW CSS: Styling for empty table message (Saran 7) */
        .empty-table-message td {
            text-align: center !important;
            font-style: italic;
            color: var(--secondary-color);
            padding: 20px;
        }

        /* --- Status & Messages --- */
        .status-lunas { color: var(--success-color); font-weight: bold; }
        .status-belum { color: var(--danger-color); font-weight: bold; }
        .status-pending { color: orange; font-weight: bold; } /* NEW STATUS */
        .status-masuk { color: var(--success-color); font-weight: bold; }
        .status-keluar { color: var(--danger-color); font-weight: bold; }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: var(--dark-color);
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }
        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @-webkit-keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        
        /* --- Modal Styling --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: var(--border-radius);
            position: relative;
            box-shadow: var(--box-shadow);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close-button:hover, .close-button:focus { color: #000; text-decoration: none; cursor: pointer; }

        /* --- Login Screen --- */
        .login-screen, .customer-login-screen {
            display: flex;
            flex-direction: column; /* Tambahkan ini agar footer hak cipta di bawah card */
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--bg-color);
        }
        .login-card {
            background-color: #fff;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }
        .login-card h2 {
            border: none;
            margin-bottom: 20px;
        }

        /* --- Laporan Print Area --- */
        .laporan-print-area {
            /* Perbaikan: Sembunyikan ini di mode layar secara default */
            display: none; 
        }

        /* --- Print Styles --- */
        @media print {
            
            /* ATURAN UMUM: Sembunyikan elemen non-konten/navigasi saat CETAK */
            .header, .sidebar, .login-screen, .customer-login-screen, .modal, .toast, .action-buttons, .stats-grid, .btn, .nav-link, #filter-tagihan-status, #filter-tagihan-bulan, #filter-tagihan-tahun, #search-pelanggan, #btn-tambah-golongan, #btn-tambah-pelanggan, #btn-buat-tagihan, #btn-tambah-kas, #btn-cetak-kas-umum, #btn-tambah-user, #kas-tipe-filter, #kas-bulan-input, #kas-tahun-input, #kas-from-input, #kas-to-input, .chart-container, .dashboard-alert, .app-footer-copyright { /* Tambahkan filter tagihan baru */
                display: none !important;
            }
            
            /* Ganti aturan body.is-printing yang lama dengan yang baru (ini adalah yang paling penting): */
            body.is-printing > * {
                visibility: hidden; /* Sembunyikan semua turunan body */
            }
            body.is-printing .print-only-container,
            body.is-printing .print-only-container * {
                visibility: visible !important; /* Kecuali container cetak dan isinya */
            }
            body.is-printing .print-only-container {
                display: block !important; /* Pastikan container cetak muncul */
                position: absolute !important; 
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Aturan umum untuk semua cetakan */
            body { 
                background-color: white !important; 
                margin: 0 !important; 
                padding: 0 !important;
            }
            
            /* NEW: Catch-all for better print quality */
            * { 
                background: transparent !important; 
                color: #000 !important; 
                box-shadow: none !important; 
                text-shadow: none !important; 
            }

            /* NEW: Handle Page Breaks and Headers */
            thead { 
                display: table-header-group !important; /* Agar header terulang di setiap halaman */
            }
            tr {
                page-break-inside: avoid !important; /* Mencegah baris terpotong */
            }
            h2 { 
                border-bottom: 1px solid #000 !important; /* Judul laporan lebih tegas */
            }
            /* Sembunyikan URL link */
            a { 
                color: #000 !important; 
                text-decoration: none !important; 
            }
            a[href]:after { 
                content: ""; /* Sembunyikan URL kecuali perlu */
            }
            
            /* Tabel umum di mode cetak */
            table { border-collapse: collapse; width: 100%; }
            table th, table td { border: 1px solid #000; padding: 8px; }
            table th { 
                background-color: #f0f0f0 !important; 
                color: #000 !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                border: 1px solid #000 !important;
            }
            table tr:nth-child(even) { background-color: #fff !important; }
            
            /* Khusus BKU agar terlihat akuntansi */
            #tabel-kas-umum tr:last-child td { border-top: 2px solid #000 !important; font-weight: bold; }
            #tabel-kas-umum .saldo-awal-row td {
                border-top: 2px solid #000 !important; 
                border-bottom: 2px solid #000 !important;
                background-color: #f0f0f0 !important; /* Perubahan warna print */
                font-weight: bold;
            }
            
            /* Pastikan pemotongan teks tidak berlaku saat dicetak */
            .truncate-text {
                white-space: normal !important;
                overflow: visible !important;
                text-overflow: clip !important;
                max-width: none !important;
            }
            
            /* Style untuk Struk/Receipt (DIUBAH untuk A4 dan simetri) */
            .laporan-print-area.receipt {
                font-family: monospace, Arial, sans-serif; 
                font-size: 12pt !important; 
                line-height: 1.4 !important; 
                width: 250mm !important; /* Lebar lebih besar, mendekati A4 */
                max-width: 250mm !important; 
                margin: 0 auto !important; /* PENTING: Pusatkan di halaman */
                padding: 5mm !important; /* Margin halaman A4 minimal */
                box-sizing: border-box !important;
            }
            
            /* Sesuaikan style di dalam struk */
            .receipt-print-container {
                display: block !important;
                border: 1px solid #000;
                padding: 10px;
                margin: 0 auto !important; /* Konten di dalam area cetak tetap di tengah */
                max-width: 100%;
            }

            .receipt-print-container .detail-row {
                display: flex;
                justify-content: space-between;
                line-height: 1.2;
                font-size: 12pt;
                width: 100%; /* Memanfaatkan lebar penuh */
            }

            .receipt-print-container .meter-table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
            }
            .receipt-print-container .meter-table th, 
            .receipt-print-container .meter-table td {
                border: 1px solid #000;
                padding: 5px;
                text-align: center;
                font-size: 10pt; 
            }
            .receipt-print-container .meter-table th {
                background-color: #eee !important;
            }
            
            /* Style untuk Total */
            .receipt-print-container .total-tagihan-row {
                font-size: 18pt !important; 
                font-weight: bold;
                border-top: 2px solid #000;
                padding-top: 5px;
                display: flex;
                justify-content: space-between;
            }
            /* Menyesuaikan alignment pada detail tagihan agar rapi */
            .receipt-print-container .detail-info-grid {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }
            .receipt-print-container .detail-info-grid > div {
                width: 49%; /* Bagi menjadi dua kolom yang hampir sama */
                box-sizing: border-box;
            }

            /* Ensure tables and content in print area look good */
            .laporan-print-area table { border: 1px solid #000; }
            .laporan-print-area th, .laporan-print-area td { border: 1px solid #000; padding: 8px; }
            .laporan-print-area h2 { border-bottom: 1px solid #000; }
            
            /* Tambahkan styling khusus untuk print BKU */
            #kas-umum-print-area {
                /* Gunakan ukuran kertas yang wajar */
                width: 100%; 
                margin: 0 auto;
                max-width: none;
                page-break-after: always;
            }
            #kas-umum-print-area table { border-collapse: collapse; }
            #kas-umum-print-area tr:last-child td { border-top: 2px solid #000 !important; font-weight: bold; }
            
            /* Hilangkan ikon sort saat cetak */
            .table-responsive th[data-sort-desc]:after { content: "" !important; }

        }
        /* --- Customer Portal Styles --- */
        .customer-app {
            display: none;
        }

        .customer-app .header {
            background-color: var(--success-color);
        }

        .customer-app .sidebar {
            background-color: #e9f7eb;
            border-right: 1px solid var(--success-color);
            display: flex; /* Tambahkan untuk footer sidebar */
            flex-direction: column; /* Tambahkan untuk footer sidebar */
        }

        .customer-app .sidebar-nav a.active {
            background-color: var(--success-color);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        /* --- Splash Screen Styles --- */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1; /* Default: Visible */
            transition: opacity 0.5s;
        }
        #splash-screen h1 {
            font-size: 2.5rem;
            margin: 0;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    
    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <h1 id="splash-title">Aplikasi Tagihan Air Loading...</h1>
        <div class="spinner"></div>
    </div>
    
    <div id="login-screen" class="login-screen" style="display: none;">
        <div class="login-card">
            <!-- ADDED ICON -->
            <!-- PERBAIKAN: Title diisi oleh JS dengan innerHTML, defaultnya kosong atau placeholder -->
            <h2 id="login-title"></h2>
            <form id="login-form">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>
                
                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
                
                <p id="login-error" style="color: var(--danger-color); margin-top: 10px;"></p>
                
                <button type="submit" class="btn btn-primary btn-block">Login Admin</button>
            </form>
            <button id="btn-go-to-customer" class="btn btn-secondary btn-block" style="margin-top: 20px;">Masuk Portal Pelanggan</button>
        </div>
        <!-- HAK CIPTA UNTUK LOGIN SCREEN -->
        <div class="login-card-footer">
            &copy; 2025 di buat oleh Evhan Syahreza | Aplikasi Tagihan Air
        </div>
    </div>

    <div id="customer-login-screen" class="login-screen" style="display: none;">
        <div class="login-card">
            <!-- ADDED ICON -->
            <h2 id="customer-login-title"><i class="fa-solid fa-circle-user" style="margin-right: 10px;"></i> Portal Pelanggan</h2>
            <form id="customer-login-form">
                <label for="c_id">Nomor Pelanggan</label>
                <input type="text" id="c_id" name="c_id" required placeholder="Cth: 1001">
                
                <label for="c_pin">PIN (4 Digit)</label>
                <!-- PERBAIKAN: Ganti type="password" menjadi type="tel" untuk UX keyboard numerik mobile -->
                <input type="tel" id="c_pin" name="c_pin" required maxlength="4" placeholder="Cth: 1234" inputmode="numeric">
                
                <p id="customer-login-error" style="color: var(--danger-color); margin-top: 10px;"></p>
                
                <button type="submit" class="btn btn-success btn-block">Login</button>
            </form>
            <button id="btn-back-to-admin" class="btn btn-secondary btn-block" style="margin-top: 20px;">Masuk Halaman Admin</button>
        </div>
        <!-- HAK CIPTA UNTUK CUSTOMER LOGIN SCREEN -->
        <div class="login-card-footer">
            &copy; 2025 di buat oleh Evhan Syahreza | Aplikasi Tagihan Air
        </div>
    </div>
    
    <div id="main-app" class="main-app" style="display: none;">
        <div class="header">
            <div class="container">
                <h1 id="header-title" class="header-title">Aplikasi Tagihan Air Sederhana</h1>
                <div class="header-actions">
                    <!-- ADDED ICON -->
                    <button id="btn-logout" class="btn btn-danger"><i class="fa-solid fa-right-from-bracket" style="margin-right: 5px;"></i> Logout Admin</button>
                </div>
            </div>
        </div>
        <div class="container main-content">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <!-- ADDED ICONS TO ALL MENU LINKS -->
                    <!-- Penambahan data-role untuk otorisasi -->
                    <a href="#" class="nav-link active" data-target="dashboard" data-role="full,petugas,keuangan"><i class="fa-solid fa-house"></i> Dashboard</a>
                    <a href="#" class="nav-link" data-target="golongan" data-role="full"><i class="fa-solid fa-layer-group"></i> Data Golongan</a>
                    <a href="#" class="nav-link" data-target="pelanggan" data-role="full,petugas"><i class="fa-solid fa-users"></i> Data Pelanggan</a>
                    <a href="#" class="nav-link" data-target="tagihan" data-role="full,petugas"><i class="fa-solid fa-file-invoice"></i> Data Tagihan</a>
                    <a href="#" class="nav-link" data-target="input-bayar" data-role="full,petugas"><i class="fa-solid fa-cash-register"></i> Input Pembayaran</a>
                    <a href="#" class="nav-link" data-target="kas-umum" data-role="full,keuangan"><i class="fa-solid fa-book-open"></i> Buku Kas Umum</a>
                    <a href="#" class="nav-link" data-target="manajemen-user" data-role="full"><i class="fa-solid fa-user-gear"></i> Manajemen User</a>
                    <a href="#" class="nav-link" data-target="administrasi" data-role="full"><i class="fa-solid fa-gear"></i> Pengaturan & Admin</a>
                </nav>
                <!-- HAK CIPTA UNTUK MAIN APP SIDEBAR -->
                <div class="app-footer-copyright">
                    &copy; 2025 di buat oleh Evhan Syahreza | Aplikasi Tagihan Air
                </div>
            </aside>
            <main class="content-area">
                
                <section id="dashboard" class="content-section active">
                    <h2>Dashboard</h2>
                    <!-- NEW: Area untuk Notifikasi Penting -->
                    <div id="dashboard-notification-area" class="dashboard-alert" style="display: none;"></div>
                    
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: var(--success-color);">
                            <h3>Jumlah Pelanggan <span class="stat-icon">üë§</span></h3>
                            <p id="stat-jml-pelanggan">0</p>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--primary-color);">
                            <h3>Total Terbayar <span id="stat-periode-terbayar"></span> <span class="stat-icon">üí∞</span></h3>
                            <p id="stat-total-terbayar">Rp 0</p>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--danger-color);">
                            <h3>Total Tunggakan <span class="stat-icon">‚ùó</span></h3>
                            <p id="stat-total-tunggakan">Rp 0</p>
                        </div>
                    </div>
                    
                    <!-- NEW: Chart Area -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <div class="stat-card" style="border-left: 5px solid orange;">
                            <h3>Total Pemasukan Kas (12 Bulan Terakhir)</h3>
                            <canvas id="chart-pemasukan" width="400" height="200"></canvas>
                        </div>
                        <div class="stat-card" style="border-left: 5px solid var(--primary-dark);">
                            <h3>Statistik Pelanggan per Golongan</h3>
                            <canvas id="chart-pelanggan-golongan" width="400" height="200"></canvas>
                        </div>
                        <div class="stat-card" style="grid-column: 1 / -1; border-left: 5px solid #17a2b8;">
                            <h3>Tren Pemakaian Air (Total m¬≥) 6 Bulan Terakhir</h3>
                            <canvas id="chart-pemakaian-air" width="800" height="200"></canvas>
                        </div>
                    </div>
                    <!-- END: Chart Area -->
                    
                </section>

                <section id="golongan" class="content-section">
                    <h2>Data Golongan</h2>
                    <button id="btn-tambah-golongan" class="btn btn-primary"><i class="fa-solid fa-plus" style="margin-right: 5px;"></i> Tambah Golongan</button>
                    <div class="table-responsive">
                        <table id="tabel-golongan">
                            <thead>
                                <tr><th>ID</th><th>Nama</th><th>Tarif Dasar (/m¬≥)</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-golongan-body"></tbody>
                        </table>
                    </div>
                </section>

                <section id="pelanggan" class="content-section">
                    <h2>Data Pelanggan</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="search-pelanggan" placeholder="Cari Pelanggan (Nama/ID)..." style="flex-grow: 1; margin: 0;">
                        <button id="btn-tambah-pelanggan" class="btn btn-primary"><i class="fa-solid fa-user-plus" style="margin-right: 5px;"></i> Tambah Pelanggan</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="tabel-pelanggan">
                            <thead>
                                <tr><th>No. Pelanggan</th><th>Nama</th><th>Alamat</th><th>Golongan</th><th>PIN Login</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-pelanggan-body"></tbody>
                        </table>
                    </div>
                </section>

                <section id="tagihan" class="content-section">
                    <h2>Data Tagihan</h2>
                    
                    <!-- START: REKAPAN TAGIHAN (NEW) -->
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;">
                        <div class="stat-card" style="border-left-color: var(--danger-color);">
                            <h3>TOTAL BELUM LUNAS</h3>
                            <p id="stat-tagihan-belum-lunas">Rp 0</p>
                        </div>
                        <div class="stat-card" style="border-left-color: orange;">
                            <h3>TOTAL MENUNGGU VALIDASI</h3>
                            <p id="stat-tagihan-pending">Rp 0</p>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--success-color);">
                            <h3>TOTAL LUNAS</h3>
                            <p id="stat-tagihan-lunas">Rp 0</p>
                        </div>
                    </div>
                    <!-- END: REKAPAN TAGIHAN -->

                    <!-- MODIFIKASI: Tambahkan filter bulan dan tahun -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
                        <select id="filter-tagihan-status" style="width: 150px; margin: 0;">
                            <option value="semua">Semua Status</option>
                            <option value="Belum Lunas">Belum Lunas</option>
                            <option value="Lunas">Lunas</option>
                            <!-- OPTION DITAMBAHKAN OLEH JS -->
                        </select>
                        <!-- NEW FILTER: Bulan dan Tahun -->
                        <input type="month" id="filter-tagihan-bulan" style="width: 150px; margin: 0;">
                        <select id="filter-tagihan-tahun" style="width: 100px; margin: 0;">
                            <!-- Opsi Tahun akan diisi oleh JS -->
                        </select>
                        <!-- END NEW FILTER -->
                        <button id="btn-buat-tagihan" class="btn btn-primary"><i class="fa-solid fa-file-circle-plus" style="margin-right: 5px;"></i> Buat Tagihan Baru</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="tabel-tagihan">
                            <thead>
                                <tr><th>ID Pelanggan</th><th>Nama</th><th data-sort-desc>Periode</th><th>Pemakaian (m¬≥)</th><th>Sumber Input</th><th>Total Tagihan</th><th>Status</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-tagihan-body"></tbody>
                        </table>
                    </div>
                </section>

                <section id="input-bayar" class="content-section">
                    <h2>Input Pembayaran</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="bayar-search-pelanggan" placeholder="Masukkan Nomor Pelanggan" style="flex-grow: 1; margin: 0;">
                        <button id="btn-cari-tagihan" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass" style="margin-right: 5px;"></i> Cari Tagihan</button>
                    </div>

                    <div id="bayar-hasil-pencarian" style="display: none; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                        </div>
                </section>
                
                <section id="kas-umum" class="content-section">
                    <h2>Buku Kas Umum</h2>
                    <button id="btn-tambah-kas" class="btn btn-primary"><i class="fa-solid fa-plus-minus" style="margin-right: 5px;"></i> Tambah Transaksi Kas</button>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                        <select id="kas-tipe-filter" style="width: 150px; margin: 0;">
                            <option value="bulanan">Bulanan</option>
                            <option value="tahunan">Tahunan</option>
                            <option value="rentang">Rentang Tanggal</option> <!-- NEW OPTION: Rentang Tanggal -->
                            <option value="semua">Semua</option>
                        </select>
                        <input type="month" id="kas-bulan-input" style="width: 150px; margin: 0;">
                        <input type="number" id="kas-tahun-input" style="width: 150px; margin: 0; display: none;" placeholder="Tahun">
                        <!-- NEW INPUTS for Date Range Filter -->
                        <input type="date" id="kas-from-input" style="width: 150px; margin: 0; display: none;" placeholder="Dari Tanggal">
                        <input type="date" id="kas-to-input" style="width: 150px; margin: 0; display: none;" placeholder="Sampai Tanggal">
                        <!-- END NEW INPUTS -->
                        <button id="btn-cetak-kas-umum" class="btn btn-success" title="Cetak langsung (Browser biasanya menyediakan opsi 'Simpan sebagai PDF' di jendela cetak)"><i class="fa-solid fa-print" style="margin-right: 5px;"></i> Cetak BKU</button>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card stat-saldo-masuk">
                            <h3>Total Pemasukan</h3>
                            <p id="stat-kas-masuk">Rp 0</p>
                        </div>
                        <div class="stat-card stat-saldo-keluar">
                            <h3>Total Pengeluaran</h3>
                            <p id="stat-kas-keluar">Rp 0</p>
                        </div>
                        <div class="stat-card stat-saldo-akhir">
                            <h3>Saldo Kas Akhir</h3>
                            <p id="stat-saldo-akhir">Rp 0</p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="tabel-kas-umum">
                            <thead>
                                <tr><th data-sort-desc>Tanggal</th><th>Waktu</th><th>Deskripsi</th><th>Masuk</th><th>Keluar</th><th>Saldo</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-kas-umum-body">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="kas-umum-print-area" class="laporan-print-area"></div>
                </section>
                
                <!-- START: MANAJEMEN USER -->
                <section id="manajemen-user" class="content-section">
                    <h2>Manajemen User Admin</h2>
                    <button id="btn-tambah-user" class="btn btn-primary"><i class="fa-solid fa-user-plus" style="margin-right: 5px;"></i> Tambah User</button>
                    <div class="table-responsive">
                        <table id="tabel-user">
                            <thead>
                                <!-- Tambahkan kolom Role/Peran -->
                                <tr><th>Username</th><th>Nama Lengkap</th><th>Role</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-user-body"></tbody>
                        </table>
                    </div>
                </section>
                <!-- END: MANAGEMEN USER -->
                
                <section id="administrasi" class="content-section">
                    <h2>Pengaturan Aplikasi</h2>
                    
                    <div class="stat-card" style="margin-bottom: 20px;">
                        <h3>Judul Aplikasi</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="input-judul-aplikasi" style="flex-grow: 1; margin: 0;">
                            <button id="btn-simpan-judul" class="btn btn-primary" style="margin: 0;"><i class="fa-solid fa-floppy-disk" style="margin-right: 5px;"></i> Simpan Judul</button>
                        </div>
                    </div>

                    <!-- NEW: UPLOAD LOGO -->
                    <h3 style="margin-top: 30px;">Pengaturan Logo Struk</h3>
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                        <label for="input-logo-aplikasi">Unggah Logo (PNG/JPG, Max 500KB)</label>
                        <input type="file" 
                            class="form-control-file" 
                            id="input-logo-aplikasi" 
                            accept="image/png, image/jpeg" 
                            style="margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <img id="preview-logo" src="" alt="Preview Logo" style="max-width: 100px; max-height: 100px; display: none; border: 1px solid #ccc; padding: 5px;">
                        </div>
                        <!-- NEW: Tombol Simpan dan Hapus Logo -->
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="btn-simpan-logo" class="btn btn-primary" style="flex-grow: 1;"><i class="fa-solid fa-floppy-disk" style="margin-right: 5px;"></i> Simpan Logo</button>
                            <button id="btn-hapus-logo" class="btn btn-danger" style="width: 150px;"><i class="fa-solid fa-trash-can" style="margin-right: 5px;"></i> Hapus Logo</button>
                        </div>
                        <!-- END NEW BUTTONS -->
                    </div>
                    <!-- END NEW: UPLOAD LOGO -->

                    <h3>Pengaturan Biaya</h3>
                    <form id="form-administrasi">
                        <label for="biaya-pemeliharaan">Biaya Pemeliharaan (per Bulan)</label>
                        <input type="number" id="biaya-pemeliharaan" required>
                        
                        <label for="biaya-administrasi">Biaya Administrasi (per Bulan)</label>
                        <input type="number" id="biaya-administrasi" required>

                        <label for="biaya-denda">Biaya Denda (Jika Lewat Tempo)</label>
                        <input type="number" id="biaya-denda" required>
                        
                        <!-- NEW INPUT FOR SUGGESTION #4 -->
                        <label for="max-usage-multiplier">Faktor Batas Pemakaian Wajar (Cth: 1.5 untuk 150%)</label>
                        <input type="number" id="max-usage-multiplier" required step="0.1" min="1">
                        <!-- END NEW INPUT -->
                        
                        <button type="submit" class="btn btn-primary"><i class="fa-solid fa-floppy-disk" style="margin-right: 5px;"></i> Simpan Biaya</button>
                    </form>
                    
                    <!-- START NEW: Pengaturan Rekening Pembayaran -->
                    <h3 style="margin-top: 30px;">Pengaturan Rekening Pembayaran</h3>
                    <form id="form-rekening-bank">
                        <label for="input-nama-bank">Nama Bank</label>
                        <input type="text" id="input-nama-bank" required placeholder="Cth: Bank BNI">
                        
                        <label for="input-nomor-rekening">Nomor Rekening</label>
                        <input type="text" id="input-nomor-rekening" required placeholder="Cth: 1234567890">

                        <label for="input-nama-pemilik-rekening">Nama Pemilik Rekening</label>
                        <input type="text" id="input-nama-pemilik-rekening" required placeholder="Cth: CV. Gusi Sejahtera">
                        
                        <button type="submit" class="btn btn-primary" id="btn-simpan-rekening-bank" style="margin-top: 10px;"><i class="fa-solid fa-floppy-disk" style="margin-right: 5px;"></i> Simpan Rekening</button>
                    </form>
                    <!-- END NEW: Pengaturan Rekening Pembayaran -->


                    <h3 style="margin-top: 30px;">Backup & Restore Data</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button id="btn-export-data" class="btn btn-secondary"><i class="fa-solid fa-download" style="margin-right: 5px;"></i> Export Data (JSON)</button>
                        <label class="btn btn-secondary" style="margin: 0; display: inline-block;">
                            <i class="fa-solid fa-upload" style="margin-right: 5px;"></i> Import Data (JSON)
                            <input type="file" id="import-file" accept=".json" style="display: none;">
                        </label>
                    </div>

                </section>

            </main>
        </div>
    </div>
    
    <div id="bukti-bayar-area" class="laporan-print-area"></div>
    
    <div id="customer-app" class="customer-app" style="display: none;">
        <div class="header">
            <div class="container">
                <h1 id="customer-header-title" class="header-title">Selamat Datang di Portal Pelanggan</h1>
                <div class="header-actions">
                    <span id="customer-name-display" style="margin-right: 10px;"></span>
                    <!-- ADDED ICON -->
                    <button id="btn-customer-logout" class="btn btn-primary"><i class="fa-solid fa-right-from-bracket" style="margin-right: 5px;"></i> Logout</button>
                </div>
            </div>
        </div>
        <div class="container main-content">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <!-- ADDED ICONS -->
                    <a href="#" class="nav-link active" data-target="input-meter-mandiri"><i class="fa-solid fa-faucet-drip"></i> Input Meter Mandiri</a>
                    <a href="#" class="nav-link" data-target="riwayat-tagihan-pelanggan"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat Tagihan</a>
                    <!-- NEW: Menu Rekening Pembayaran -->
                    <a href="#" class="nav-link" data-target="rekening-pembayaran"><i class="fa-solid fa-money-check-dollar"></i> Rekening Pembayaran</a>
                </nav>
                <!-- HAK CIPTA UNTUK CUSTOMER APP SIDEBAR -->
                <div class="app-footer-copyright">
                    &copy; 2025 di buat oleh Evhan Syahreza | Aplikasi Tagihan Air
                </div>
            </aside>
            <main class="content-area">
                
                <section id="input-meter-mandiri" class="content-section active">
                    <h2>Input Meter Mandiri - Periode <span id="periode-input-display"></span></h2>
                    
                    <div id="meter-input-status" style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px;">
                        </div>

                    <form id="form-input-meter-mandiri" style="display: none;">
                        <label for="meter_awal_c">Meter Awal (Otomatis)</label>
                        <input type="number" id="meter_awal_c" readonly style="background-color: #eee;">
                        
                        <label for="meter_akhir_c">Meter Akhir (Bulan Ini)</label>
                        <input type="number" id="meter_akhir_c" required placeholder="Masukkan angka meter akhir Anda">
						
						<div class="form-group">
                            <label for="bukti-validasi-foto">Unggah Bukti Validasi (Foto Meteran, dll.) <span class="text-danger">*</span></label>
                            <!-- NOTE: Dalam konteks single-file app, kita hanya menyimpan nama file/URL data URI. -->
                            <input type="file" 
                                class="form-control-file" 
                                id="bukti-validasi-foto" 
                                name="bukti_foto" 
                                accept="image/jpeg, image/png" 
                                required>
                            <small class="form-text text-muted">Hanya format JPG/PNG. Maksimal 2MB.</small>
                        </div>
                        
                        <button type="submit" class="btn btn-success btn-block">Simpan Pembacaan Meter</button>
                    </form>
                </section>

                <section id="riwayat-tagihan-pelanggan" class="content-section">
                    <h2>Riwayat Tagihan Anda</h2>
                    <div class="table-responsive">
                        <table id="tabel-riwayat-tagihan">
                            <thead>
                                <!-- PENAMBAHAN KOLOM METER AWAL DAN AKHIR -->
                                <!-- MODIFIKASI: Tambahkan kolom Aksi -->
                                <tr><th>No. Pembayaran</th><th data-sort-desc>Periode</th><th>Mtr Awal</th><th>Mtr Akhir</th><th>Pemakaian (m¬≥)</th><th>Total Tagihan</th><th>Status</th><th>Tgl Bayar</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tabel-riwayat-tagihan-pelanggan">
                                </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- START NEW: REKENING PEMBAYARAN SECTION -->
                <section id="rekening-pembayaran" class="content-section">
                    <h2>Rekening Pembayaran Resmi</h2>
                    <div id="rekening-display" style="padding: 20px; border: 1px solid var(--success-color); border-radius: var(--border-radius); background-color: #e9f7eb;">
                        <p>Informasi rekening akan ditampilkan di sini setelah dikonfigurasi oleh Admin.</p>
                    </div>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; font-size: 0.9em;">
                        <p style="font-weight: bold; color: var(--danger-color);">PERHATIAN:</p>
                        <p>Harap hanya melakukan transfer ke rekening di atas dan pastikan nama pemilik rekening sudah benar. Setelah transfer, Admin akan memproses validasi pembayaran Anda.</p>
                    </div>
                </section>
                <!-- END NEW: REKENING PEMBAYARAN SECTION -->

            </main>
        </div>
    </div>


    <div id="modal-golongan" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-golongan-title">Tambah Golongan</h3>
            <form id="form-golongan">
                <input type="hidden" id="id_golongan" name="id_golongan">
                <label for="nama_golongan">Nama Golongan</label>
                <input type="text" id="nama_golongan" name="nama_golongan" required>
                <label for="tarif_golongan">Tarif Dasar per m¬≥ (IDR)</label>
                <input type="number" id="tarif_golongan" name="tarif_golongan" required min="0">
                <button type="submit" class="btn btn-primary btn-block">Simpan</button>
            </form>
        </div>
    </div>

    <div id="modal-pelanggan" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-pelanggan-title">Tambah Pelanggan</h3>
            <form id="form-pelanggan">
                <input type="hidden" id="pelanggan-id-edit">
                <label for="nomor_pelanggan">Nomor Pelanggan (ID)</label>
                <input type="text" id="nomor_pelanggan" name="nomor_pelanggan" required placeholder="Cth: 1003">
                <label for="nama_pelanggan">Nama Pelanggan</label>
                <input type="text" id="nama_pelanggan" name="nama_pelanggan" required>
                <label for="alamat_pelanggan">Alamat</label>
                <textarea id="alamat_pelanggan" name="alamat_pelanggan" required></textarea>
                <label for="select-golongan-pelanggan">Golongan</label>
                <select id="select-golongan-pelanggan" required></select>
                <label for="pin_pelanggan">PIN Login Pelanggan (4 digit)</label>
                <input type="text" pattern="[0-9]{4}" id="pin_pelanggan" name="pin_pelanggan" maxlength="4" placeholder="Isi PIN 4 digit. Default: 1234">

                <button type="submit" class="btn btn-primary btn-block">Simpan</button>
            </form>
        </div>
    </div>

    <div id="modal-tagihan" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-tagihan-title">Buat Tagihan</h3>
            <form id="form-tagihan">
                <input type="hidden" id="tagihan-id-edit">
                <label for="select-pelanggan-tagihan">Pelanggan</label>
                <select id="select-pelanggan-tagihan" required></select>
                <label for="periode_tagihan">Periode Tagihan</label>
                <input type="month" id="periode_tagihan" required>
                <label for="meter_awal">Meter Awal (m¬≥)</label>
                <input type="number" id="meter_awal" required min="0"> 
                <label for="meter_akhir">Meter Akhir (m¬≥)</label>
                <input type="number" id="meter_akhir" required min="0">
                <div id="meter-akhir-feedback-container"></div> <!-- NEW: Container Feedback Meter Akhir -->
                <div id="tgl-bayar-wrapper" style="margin-top: 10px; display: none;">
                    <label for="tgl_bayar">Tanggal Pembayaran</label>
                    <input type="date" id="tgl_bayar" name="tgl_bayar"> 
                </div>
                
                <button type="submit" class="btn btn-primary btn-block">Simpan Tagihan</button>
            </form>
        </div>
    </div>

    <div id="modal-pembayaran" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Konfirmasi Pembayaran</h3>
            <form id="form-pembayaran">
                <input type="hidden" id="bayar-tagihan-id">
                <p>Pelanggan: <strong id="bayar-nama-pelanggan"></strong></p>
                <p>Periode: <strong id="bayar-periode"></strong></p>
                <h3 style="color: var(--danger-color); margin: 15px 0;">TOTAL TAGIHAN: <span id="bayar-total-tagihan" data-total="0">Rp 0</span></h3>
                
                <label for="jumlah-uang-bayar">Jumlah Uang Bayar</label>
                <input type="number" id="jumlah-uang-bayar" required min="0">

                <p>Kembalian: <strong id="kembalian-display" class="status-belum">Uang Kurang</strong></p>
                
                <button type="submit" id="btn-konfirmasi-pembayaran" class="btn btn-success btn-block" disabled>Konfirmasi Bayar</button>
            </form>
        </div>
    </div>

    <div id="modal-kas" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-kas-title">Tambah Transaksi Kas</h3>
            <form id="form-kas">
                <input type="hidden" id="kas-id-edit">
                <label for="kas_tanggal">Tanggal Transaksi</label>
                <input type="date" id="kas_tanggal" name="kas_tanggal" required>
                
                <label for="kas_tipe">Tipe Transaksi</label>
                <select id="kas_tipe" required>
                    <option value="MASUK">MASUK (Pemasukan Lain)</option>
                    <option value="KELUAR">KELUAR (Pengeluaran)</option>
                </select>
                
                <label for="kas_deskripsi">Deskripsi</label>
                <input type="text" id="kas_deskripsi" name="kas_deskripsi" required>
                
                <label for="kas_jumlah">Jumlah (IDR)</label>
                <input type="number" id="kas_jumlah" name="kas_jumlah" required min="1">
                
                <button type="submit" class="btn btn-primary btn-block">Simpan Transaksi</button>
            </form>
        </div>
    </div>
    
    <!-- START: MODAL USER -->
    <div id="modal-user" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-user-title">Tambah User Admin</h3>
            <form id="form-user">
                <input type="hidden" id="user-id-edit">
                <label for="user_nama_lengkap">Nama Lengkap</label>
                <input type="text" id="user_nama_lengkap" name="user_nama_lengkap" required>
                <label for="user_username">Username</label>
                <input type="text" id="user_username" name="user_username" required>
                <label for="user_role">Peran (Role)</label>
                <select id="user_role" required>
                    <option value="full">Administrator Penuh</option>
                    <option value="petugas">Petugas Lapangan & Pembayaran</option>
                    <option value="keuangan">Staff Keuangan</option>
                </select>
                <label for="user_password">Password (Kosongkan jika tidak diubah)</label>
                <input type="password" id="user_password" name="user_password">
                <button type="submit" class="btn btn-primary btn-block">Simpan User</button>
            </form>
        </div>
    </div>
    <!-- END: MODAL USER -->
    
    <!-- NEW: Modal untuk menampilkan gambar bukti foto -->
    <div id="modal-bukti-foto" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-button">&times;</span>
            <h3 id="modal-foto-title">Bukti Foto Tagihan Mandiri</h3>
            <p>Pelanggan: <strong id="foto-pelanggan-info"></strong> | Periode: <strong id="foto-periode-info"></strong></p>
            <img id="bukti-foto-display" src="" alt="Bukti Foto Meteran" style="width: 100%; height: auto; border-radius: 4px; margin-top: 10px;">
        </div>
    </div>
    <!-- END: Modal Bukti Foto -->

    <div id="toast" class="toast">Pesan Anda</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const Utils = {
            formatCurrency: (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number),
            generateId: (prefix) => `${prefix}${Date.now()}`,
            getTodayDate: () => new Date().toISOString().slice(0, 10),
            getPrevMonth: (dateString) => { const d = dateString ? new Date(dateString + '-01') : new Date(); d.setMonth(d.getMonth() - 1); return d.toISOString().slice(0, 7); },
            getCurrentPeriode: () => new Date().toISOString().slice(0, 7),
            formatDateID: (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric'}),
            // NEW: Format Tanggal Pendek (DD-MM-YYYY)
            formatDateShort: (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric'}),
            formatPeriode: (periodeString) => { if (!periodeString) return 'N/A'; const [y, m] = periodeString.split('-'); return new Date(y, m - 1).toLocaleString('id-ID', { month: 'long', year: 'numeric' }); },
            calculateTagihanTotal: (biayaAir, biayaPemeliharaan, biayaAdmin, denda = 0) => biayaAir + biayaPemeliharaan + biayaAdmin + denda,
            // NEW: Dapatkan daftar periode (YYYY-MM) 12 bulan terakhir
            get12MonthsAgo: () => {
                const periods = [];
                for (let i = 11; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    periods.push(d.toISOString().slice(0, 7));
                }
                return periods;
            },
            // NEW: Format YYYY-MM ke Bulan YYYY (Jan 2024)
            formatMonthYear: (ym) => {
                 const [y, m] = ym.split('-');
                 return new Date(y, m - 1).toLocaleString('id-ID', { month: 'short', year: 'numeric' });
            }
        };
        
        // NEW UTILITY: Set Button Loading State (Suggestion 5)
        const setButtonState = (btn, isLoading, originalText = 'Simpan') => {
            if (isLoading) {
                // Gunakan class spinner yang sudah ada di CSS
                btn.dataset.originalText = btn.textContent;
                btn.innerHTML = `<div class="spinner" style="width:15px;height:15px;border-width:2px;margin-right:5px;display:inline-block;"></div> Loading...`;
                btn.disabled = true;
            } else {
                btn.innerHTML = btn.dataset.originalText || originalText;
                btn.disabled = false;
            }
        };

        const Auth = {
            mode: 'customer', 
            loggedAdmin: false,
            loggedCustomer: null, 
            currentUser: null, // NEW: Menyimpan objek user yang sedang login

            checkLogin() {
                const userId = sessionStorage.getItem('currentAdminUser') || null;
                this.loggedAdmin = !!userId;
                this.currentUser = userId ? State.data.users.find(u => u.id === userId) : null;
                this.loggedCustomer = sessionStorage.getItem('isCustomerLoggedIn') || null;

                if (this.loggedAdmin && this.currentUser) {
                    this.mode = 'admin';
                    UI.showAdminApp();
                    Handlers.applyRoleRestrictions(this.currentUser.role); // NEW
                    App.render(); 
                    Handlers.checkJatuhTempoNotification(); // NEW
                } else if (this.loggedCustomer) {
                    this.mode = 'customer';
                    UI.showCustomerApp();
                    App.render(); 
                } else {
                    this.mode = 'admin'; 
                    UI.showAdminLoginScreen();
                }
            },

            loginAdmin(username, password, btn) { // ADDED btn parameter
                const user = State.data.users.find(u => u.username === username && u.password === password);
                
                // Clear loading state after check
                setButtonState(btn, false, 'Login Admin');

                if (user) {
                    sessionStorage.setItem('currentAdminUser', user.id); // Simpan ID user
                    this.currentUser = user; // Set currentUser saat login berhasil
                    sessionStorage.removeItem('isCustomerLoggedIn');
                    document.getElementById('login-error').textContent = ''; 
                    this.checkLogin();
                } else {
                    document.getElementById('login-error').textContent = 'Username atau password salah.';
                }
            },

            loginCustomer(id, pin, btn) { // ADDED btn parameter
                const customer = State.data.pelanggan.find(p => p.id === id);
                
                // Clear loading state after check
                setButtonState(btn, false, 'Login');

                if (customer && customer.loginPin === pin) {
                    sessionStorage.setItem('isCustomerLoggedIn', id);
                    sessionStorage.removeItem('currentAdminUser');
                    this.currentUser = null;
                    document.getElementById('customer-login-error').textContent = ''; 
                    this.checkLogin();
                } else {
                    document.getElementById('customer-login-error').textContent = 'Nomor Pelanggan atau PIN salah.';
                }
            },
            
            // FIX: Set logout to go to correct default login screen
            logoutAdmin() { sessionStorage.removeItem('currentAdminUser'); this.currentUser = null; this.mode = 'admin'; UI.showAdminLoginScreen(); },
            logoutCustomer() { sessionStorage.removeItem('isCustomerLoggedIn'); this.mode = 'admin'; UI.showAdminLoginScreen(); }
        };

        const UI = {
            elements: {
                mainApp: document.querySelector('.main-app'), loginScreen: document.getElementById('login-screen'), loginForm: document.getElementById('login-form'), navLinks: document.querySelectorAll('.main-app .nav-link'), 
                contentSections: document.querySelectorAll('.main-app .content-section'), closeButtons: document.querySelectorAll('.close-button'), toast: document.getElementById('toast'),
                modalGolongan: document.getElementById('modal-golongan'), modalPelanggan: document.getElementById('modal-pelanggan'), modalTagihan: document.getElementById('modal-tagihan'), 
                modalPembayaran: document.getElementById('modal-pembayaran'), modalKas: document.getElementById('modal-kas'), modalUser: document.getElementById('modal-user'), 
                modalBuktiFoto: document.getElementById('modal-bukti-foto'), // NEW MODAL
                formGolongan: document.getElementById('form-golongan'), formPelanggan: document.getElementById('form-pelanggan'), formTagihan: document.getElementById('form-tagihan'),
                formAdministrasi: document.getElementById('form-administrasi'), formPembayaran: document.getElementById('form-pembayaran'), formKas: document.getElementById('form-kas'), 
                formUser: document.getElementById('form-user'), 
                tabelGolonganBody: document.getElementById('tabel-golongan-body'), tabelPelangganBody: document.getElementById('tabel-pelanggan-body'), tabelTagihanBody: document.getElementById('tabel-tagihan-body'), 
                tabelUserBody: document.getElementById('tabel-user-body'), 
                selectGolonganPelanggan: document.getElementById('select-golongan-pelanggan'), selectPelangganTagihan: document.getElementById('select-pelanggan-tagihan'), 
                statJmlPelanggan: document.getElementById('stat-jml-pelanggan'), statTotalTerbayar: document.getElementById('stat-total-terbayar'), statTotalTunggakan: document.getElementById('stat-total-tunggakan'),
                searchPelanggan: document.getElementById('search-pelanggan'), 
                filterTagihanStatus: document.getElementById('filter-tagihan-status'), btnExport: document.getElementById('btn-export-data'), importFile: document.getElementById('import-file'), 
                btnLogout: document.getElementById('btn-logout'), appTitle: document.getElementById('app-title'), headerTitle: document.getElementById('header-title'), loginTitle: document.getElementById('login-title'), 
                inputJudulAplikasi: document.getElementById('input-judul-aplikasi'), btnSimpanJudul: document.getElementById('btn-simpan-judul'), bayarSearchPelanggan: document.getElementById('bayar-search-pelanggan'),
                btnCariTagihan: document.getElementById('btn-cari-tagihan'), bayarHasilPencarian: document.getElementById('bayar-hasil-pencarian'),
                customerLoginScreen: document.getElementById('customer-login-screen'), customerApp: document.getElementById('customer-app'), customerLoginForm: document.getElementById('customer-login-form'),
                customerNavLinks: document.querySelectorAll('#customer-app .nav-link'), customerContentSections: document.querySelectorAll('#customer-app .content-section'),
                customerNameDisplay: document.getElementById('customer-name-display'), periodeInputDisplay: document.getElementById('periode-input-display'), meterInputStatus: document.getElementById('meter-input-status'),
                formInputMeterMandiri: document.getElementById('form-input-meter-mandiri'), meterAwalC: document.getElementById('meter_awal_c'), meterAkhirC: document.getElementById('meter_akhir_c'),
                tabelRiwayatTagihanPelanggan: document.getElementById('tabel-riwayat-tagihan-pelanggan'), customerHeaderTitle: document.getElementById('customer-header-title'),
                
                // Kas Umum Elements
                statKasMasuk: document.getElementById('stat-kas-masuk'), statKasKeluar: document.getElementById('stat-kas-keluar'), statSaldoAkhir: document.getElementById('stat-saldo-akhir'),
                tabelKasUmumBody: document.getElementById('tabel-kas-umum-body'), kasTanggal: document.getElementById('kas_tanggal'),
                
                // Kas Umum Filter Elements (UPDATED with new inputs)
                kasTipeFilter: document.getElementById('kas-tipe-filter'),
                kasBulanInput: document.getElementById('kas-bulan-input'),
                kasTahunInput: document.getElementById('kas-tahun-input'),
                kasFromInput: document.getElementById('kas-from-input'), // NEW
                kasToInput: document.getElementById('kas-to-input'),   // NEW
                btnCetakKasUmum: document.getElementById('btn-cetak-kas-umum'),
                kasUmumPrintArea: document.getElementById('kas-umum-print-area'),
                
                // NEW: Tagihan Filter Elements
                filterTagihanBulan: document.getElementById('filter-tagihan-bulan'),
                filterTagihanTahun: document.getElementById('filter-tagihan-tahun'),
                
                // Splash Screen
                splashScreen: document.getElementById('splash-screen'),
                
                // New Administrasi Input (Suggestion 4)
                maxUsageMultiplierInput: document.getElementById('max-usage-multiplier'),

                // NEW Rekening Bank Elements
                inputNamaBank: document.getElementById('input-nama-bank'),
                inputNomorRekening: document.getElementById('input-nomor-rekening'),
                inputNamaPemilikRekening: document.getElementById('input-nama-pemilik-rekening'),
                formRekeningBank: document.getElementById('form-rekening-bank'),
                rekeningDisplay: document.getElementById('rekening-display'),
                
                // NEW Logo Elements
                inputLogoAplikasi: document.getElementById('input-logo-aplikasi'),
                previewLogo: document.getElementById('preview-logo'),
                btnSimpanLogo: document.getElementById('btn-simpan-logo'), // NEW
                btnHapusLogo: document.getElementById('btn-hapus-logo'),   // NEW
                
                // NEW: Tagihan Stats (Rekapan)
                statTagihanBelumLunas: document.getElementById('stat-tagihan-belum-lunas'),
                statTagihanPending: document.getElementById('stat-tagihan-pending'),
                statTagihanLunas: document.getElementById('stat-tagihan-lunas'),
                
                // NEW: Chart Elements
                chartPemasukanCtx: document.getElementById('chart-pemasukan'),
                chartPelangganGolonganCtx: document.getElementById('chart-pelanggan-golongan'),
                chartPemakaianAirCtx: document.getElementById('chart-pemakaian-air'),
                
                // NEW: Dashboard Info
                statPeriodeTerbayar: document.getElementById('stat-periode-terbayar'),
                dashboardNotificationArea: document.getElementById('dashboard-notification-area'),
                
                // NEW: Feedback Meter Akhir
                meterAkhirFeedbackContainer: document.getElementById('meter-akhir-feedback-container'),
            },
            
            showAdminApp() { 
                this.elements.loginScreen.style.display = 'none'; 
                this.elements.customerLoginScreen.style.display = 'none'; 
                this.elements.customerApp.style.display = 'none'; 
                this.elements.mainApp.style.display = 'block'; 
                Handlers.navigation({ target: this.elements.navLinks[0], preventDefault: () => {} }); 
            }, 
            showCustomerApp() { 
                this.elements.loginScreen.style.display = 'none'; 
                this.elements.customerLoginScreen.style.display = 'none'; 
                this.elements.mainApp.style.display = 'none'; 
                this.elements.customerApp.style.display = 'block'; 
                Handlers.renderCustomerPortal(); 
                Handlers.handleCustomerNavigation({ target: this.elements.customerNavLinks[0], preventDefault: () => {} }); 
            }, 
            showAdminLoginScreen() { 
                // Clear current user on logging out to login screen
                Auth.currentUser = null; 
                sessionStorage.removeItem('currentAdminUser');
                this.elements.loginScreen.style.display = 'flex'; 
                this.elements.customerLoginScreen.style.display = 'none'; 
                this.elements.mainApp.style.display = 'none'; 
                this.elements.customerApp.style.display = 'none'; 
            },
            showCustomerLoginScreen() { this.elements.customerLoginScreen.style.display = 'flex'; this.elements.loginScreen.style.display = 'none'; this.elements.mainApp.style.display = 'none'; this.elements.customerApp.style.display = 'none'; },
            showToast(message) { this.elements.toast.textContent = message; this.elements.toast.className = 'show'; setTimeout(() => { this.elements.toast.className = ''; }, 3000); },
            openModal(modalElement) { modalElement.style.display = 'flex'; },
            closeModal(modalElement) { modalElement.style.display = 'none'; },
            closeAllModals() { this.closeModal(this.elements.modalGolongan); this.closeModal(this.elements.modalPelanggan); this.closeModal(this.elements.modalTagihan); this.closeModal(this.elements.modalPembayaran); this.closeModal(this.elements.modalKas); this.closeModal(this.elements.modalUser); this.closeModal(document.getElementById('modal-bukti-foto')); }, // Tutup modal foto
            setupModalGolongan(golongan = null) {
                const form = this.elements.formGolongan; form.reset(); const title = this.elements.modalGolongan.querySelector('#modal-golongan-title');
                const idInput = form.querySelector('#id_golongan');
                if (golongan) { title.textContent = 'Edit Golongan'; idInput.value = golongan.id; idInput.readOnly = true; form.querySelector('#nama_golongan').value = golongan.nama; form.querySelector('#tarif_golongan').value = golongan.tarif;
                } else { title.textContent = 'Tambah Golongan'; idInput.readOnly = false; idInput.value = ''; }
                this.openModal(this.elements.modalGolongan);
            },
            setupModalPelanggan(allGolongan, pelanggan = null) {
                const form = this.elements.formPelanggan; form.reset(); this.populateGolonganSelect(allGolongan);
                const title = this.elements.modalPelanggan.querySelector('#modal-pelanggan-title'); const idInput = form.querySelector('#pelanggan-id-edit');
                const noPelangganInput = form.querySelector('#nomor_pelanggan'); const pinInput = form.querySelector('#pin_pelanggan');
                if (pelanggan) { 
                    title.textContent = 'Edit Pelanggan'; idInput.value = pelanggan.id; noPelangganInput.value = pelanggan.id; noPelangganInput.readOnly = true; 
                    form.querySelector('#nama_pelanggan').value = pelanggan.nama; form.querySelector('#alamat_pelanggan').value = pelanggan.alamat; 
                    this.elements.selectGolonganPelanggan.value = pelanggan.golonganId; pinInput.placeholder = `Isi PIN baru (4 digit). PIN saat ini: ****`; pinInput.value = ''; // Masking PIN di placeholder
                } else { 
                    title.textContent = 'Tambah Pelanggan'; idInput.value = ''; noPelangganInput.readOnly = false; noPelangganInput.value = ''; pinInput.placeholder = 'Isi PIN 4 digit. Default: 1234';
                }
                this.openModal(this.elements.modalPelanggan);
            },
            setupModalTagihan(allPelanggan, tagihan = null) {
                const form = this.elements.formTagihan; 
                const title = this.elements.modalTagihan.querySelector('#modal-tagihan-title');
                const tglBayarWrapper = form.querySelector('#tgl-bayar-wrapper');
                const tglBayarInput = form.querySelector('#tgl_bayar'); 
                
                // FIX: Reset form dan tampilan dengan bersih
                form.reset(); 
                this.populatePelangganSelect(allPelanggan); 
                form.querySelectorAll('input, select').forEach(el => { el.readOnly = false; el.disabled = false; });
                tglBayarWrapper.style.display = 'none';
                tglBayarInput.removeAttribute('required'); 
                
                // NEW: Bersihkan feedback visual
                this.elements.meterAkhirFeedbackContainer.innerHTML = '';
                
                // Hapus tombol Lihat Foto jika ada
                const existingBtn = form.querySelector('button[data-action="view-foto"]');
                if(existingBtn) existingBtn.remove();
                
                if (tagihan) {
                    form.querySelector('#tagihan-id-edit').value = tagihan.id; 
                    form.querySelector('#select-pelanggan-tagihan').value = tagihan.pelanggan_id;
                    form.querySelector('#periode_tagihan').value = tagihan.periode; 
                    form.querySelector('#meter_awal').value = tagihan.meter_awal;
                    form.querySelector('#meter_akhir').value = tagihan.meter_akhir;
                    
                    // JIKA STATUS SUDAH LUNAS
                    if (tagihan.status === 'Lunas') {
                        title.textContent = 'Edit Tanggal Pembayaran'; 
                        tglBayarWrapper.style.display = 'block'; 
                        tglBayarInput.setAttribute('required', 'required'); 
                        // FIX #7: Memastikan periodeBayar terisi saat edit
                        form.querySelector('#tgl_bayar').value = tagihan.periodeBayar; 
                        form.querySelector('#select-pelanggan-tagihan').disabled = true; 
                        ['periode_tagihan', 'meter_awal', 'meter_akhir'].forEach(id => form.querySelector(`#${id}`).readOnly = true);
                    } 
                    // JIKA STATUS MENUNGGU VALIDASI (TIDAK BOLEH EDIT METER, HANYA ADMIN YANG BISA SETELAH VALIDASI)
                    else if (tagihan.status === 'Menunggu Validasi') {
                        title.textContent = 'Lihat Tagihan (Menunggu Validasi)'; 
                        form.querySelector('#select-pelanggan-tagihan').disabled = true; 
                        ['periode_tagihan', 'meter_awal', 'meter_akhir'].forEach(id => form.querySelector(`#${id}`).readOnly = true);
                        
                        // NEW: Tambahkan tombol Lihat Foto di modal jika ada foto
                        const btnLihatFoto = document.createElement('button');
                        btnLihatFoto.className = 'btn btn-secondary btn-block';
                        btnLihatFoto.textContent = 'Lihat Bukti Foto Meteran';
                        btnLihatFoto.type = 'button';
                        btnLihatFoto.setAttribute('data-action', 'view-foto');
                        btnLihatFoto.setAttribute('data-id', tagihan.id);
                        btnLihatFoto.style.marginBottom = '15px';
                        
                        // Sisipkan tombol sebelum tombol submit (jika ada)
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            form.insertBefore(btnLihatFoto, submitBtn);
                            btnLihatFoto.addEventListener('click', (e) => Handlers.tagihanAction.call(Handlers, { target: e.target }));
                        }
                    }
                    else { 
                        title.textContent = 'Edit Tagihan'; 
                        // Pastikan meter awal bisa diedit
                        form.querySelector('#meter_awal').readOnly = false;
                    }
                } else { 
                    title.textContent = 'Buat Tagihan'; 
                    form.querySelector('#tagihan-id-edit').value = ''; 
                    form.querySelector('#periode_tagihan').value = Utils.getCurrentPeriode();
                    form.querySelector('#meter_awal').value = ''; 
                    form.querySelector('#meter_akhir').value = '';
                    // Pastikan meter awal bisa diedit/diisi otomatis
                    form.querySelector('#meter_awal').readOnly = false; 
                }
                this.openModal(this.elements.modalTagihan);
                // Panggil auto-fill untuk mode buat baru (atau edit, tapi diabaikan di fungsi jika ada idEdit)
                Handlers.setupTagihanMeterAutoFill({ target: form.querySelector('#select-pelanggan-tagihan') });
                // Panggil visual validation untuk mode edit
                if (tagihan) Handlers.validateMeterAkhirVisual();
            },
            setupModalPembayaran(tagihan) {
                const modal = this.elements.modalPembayaran;
                const form = this.elements.formPembayaran;
                const pelanggan = State.data.pelanggan.find(p => p.id === tagihan.pelanggan_id);
                form.reset();
                modal.querySelector('#bayar-tagihan-id').value = tagihan.id;
                modal.querySelector('#bayar-nama-pelanggan').textContent = pelanggan.nama;
                modal.querySelector('#bayar-periode').textContent = Utils.formatPeriode(tagihan.periode);
                modal.querySelector('#bayar-total-tagihan').textContent = Utils.formatCurrency(tagihan.total_tagihan);
                modal.querySelector('#bayar-total-tagihan').dataset.total = tagihan.total_tagihan;
                modal.querySelector('#kembalian-display').textContent = 'Uang Kurang';
                modal.querySelector('#kembalian-display').classList.replace('status-lunas', 'status-belum');
                modal.querySelector('#btn-konfirmasi-pembayaran').disabled = true;
                this.openModal(modal);
            },
            setupModalKas(kasEntry = null) {
                const form = this.elements.formKas;
                const title = this.elements.modalKas.querySelector('#modal-kas-title');
                form.reset();
                if (kasEntry) {
                    title.textContent = 'Edit Transaksi Kas';
                    form.querySelector('#kas-id-edit').value = kasEntry.id;
                    form.querySelector('#kas_tanggal').value = kasEntry.tanggal;
                    form.querySelector('#kas_tipe').value = kasEntry.tipe;
                    form.querySelector('#kas_deskripsi').value = kasEntry.deskripsi;
                    form.querySelector('#kas_jumlah').value = kasEntry.jumlah;
                } else {
                    title.textContent = 'Tambah Transaksi Kas';
                    form.querySelector('#kas-id-edit').value = '';
                    form.querySelector('#kas_tanggal').value = Utils.getTodayDate(); 
                }
                this.openModal(this.elements.modalKas);
            },
            setupModalUser(user = null) {
                const form = this.elements.formUser; form.reset(); 
                const title = this.elements.modalUser.querySelector('#modal-user-title');
                const userUsernameInput = form.querySelector('#user_username');
                const userPasswordInput = form.querySelector('#user_password');
                const userRoleInput = form.querySelector('#user_role');
                
                if (user) {
                    title.textContent = 'Edit User Admin';
                    form.querySelector('#user-id-edit').value = user.id;
                    userUsernameInput.value = user.username;
                    userUsernameInput.readOnly = user.username === 'admin'; // Admin user tidak boleh ganti username
                    form.querySelector('#user_nama_lengkap').value = user.namaLengkap;
                    userRoleInput.value = user.role;
                    userPasswordInput.placeholder = 'Kosongkan jika tidak diubah';
                    // Admin utama tidak boleh ganti role
                    userRoleInput.disabled = user.username === 'admin';
                } else {
                    title.textContent = 'Tambah User Admin';
                    form.querySelector('#user-id-edit').value = '';
                    userUsernameInput.readOnly = false;
                    userPasswordInput.placeholder = 'Wajib diisi';
                    userRoleInput.disabled = false;
                    userRoleInput.value = 'petugas'; // Default role
                }
                this.openModal(this.elements.modalUser);
            },
            populateGolonganSelect(g) { this.elements.selectGolonganPelanggan.innerHTML = '<option value="">-- Pilih Golongan --</option>' + g.map(i => `<option value="${i.id}">${i.nama} (${Utils.formatCurrency(i.tarif)})</option>`).join(''); },
            populatePelangganSelect(p) { this.elements.selectPelangganTagihan.innerHTML = '<option value="">-- Pilih Pelanggan --</option>' + p.map(i => `<option value="${i.id}">${i.id} - ${i.nama}</option>`).join(''); }
        };

        const State = {
            data: {},
            getDefaultData() { return { 
                // UPDATED: Added max_usage_multiplier (Suggestion 4) dan logoBase64
                pengaturanAplikasi: { 
                    judulAplikasi: 'Program Penyediaan Air Minum dan Sanitasi Berbasis Masyarakat (GUSI SEJAHTERA)', // Perbarui judul default
                    biaya: { 
                        pemeliharaan: 5000, 
                        administrasi: 2500, 
                        denda: 10000, 
                        max_usage_multiplier: 1.5 
                    },
                    logoBase64: null, // NEW: Simpan Base64 Logo di sini
                    // NEW: Tambahkan Rekening Bank
                    rekeningBank: {
                        namaBank: 'Bank Rakyat Indonesia',
                        nomorRekening: '1234567890',
                        namaPemilikRekening: 'GUSI SEJAHTERA'
                    }
                }, 
                golongan: [ { id: 'R1', nama: 'Rumah Tangga 1', tarif: 2500 }, { id: 'R2', nama: 'Rumah Tangga 2', tarif: 3500 }, { id: 'NIAGA', nama: 'Niaga', tarif: 5000 }, ], 
                pelanggan: [
                    { id: '1001', nama: 'Evhan Syahreza', alamat: 'Jalan Kenanga No. 12', golonganId: 'R1', loginPin: '1234' },
                    { id: '1002', nama: 'Ria Santika', alamat: 'Jalan Mawar No. 1', golonganId: 'R2', loginPin: '1234' },
                ], 
                tagihan: [], 
                kas: [], 
                // TAMBAH: Data User Admin - Tambahkan Role
                users: [
                    { id: Utils.generateId('usr'), username: 'admin', password: 'admin', namaLengkap: 'Administrator Utama', role: 'full' }
                ],
                // NEW: Metadata untuk diagnostik penyimpanan
                metadata: {
                    lastSaveTimestamp: Date.now()
                }
            } },
            load() { 
                const d = localStorage.getItem('appData'); 
                const defaultData = this.getDefaultData();
                if (d) { 
                    let loadedData;
                    try {
                        loadedData = JSON.parse(d); 
                    } catch(e) {
                        console.error("Error parsing localStorage data:", e);
                        UI.showToast('Data corrupt! Memuat data default baru. Silakan lakukan Import jika punya backup.');
                        this.data = defaultData;
                        // Hapus data lama yang rusak
                        localStorage.removeItem('appData');
                        this.save();
                        return;
                    }
                    this.data = loadedData;
                    
                    // --- START MIGRASI DATA LAMA ---
                    // Pastikan semua properti ada, jika tidak, gunakan nilai default.
                    if (!this.data.pengaturanAplikasi) this.data.pengaturanAplikasi = defaultData.pengaturanAplikasi; 
                    if (!this.data.kas) this.data.kas = defaultData.kas;
                    if (!this.data.users || this.data.users.length === 0) this.data.users = defaultData.users; 
                    if (!this.data.metadata) this.data.metadata = defaultData.metadata; // NEW: Pastikan ada metadata
                    
                    // Migration: Tambahkan role default jika user lama tidak punya (misalnya: full)
                    this.data.users = this.data.users.map(u => ({...u, role: u.role || (u.username === 'admin' ? 'full' : 'petugas')}));
                    
                    // FIX: Ensure new setting is loaded if missing (Suggestion 4)
                    if (this.data.pengaturanAplikasi.biaya.max_usage_multiplier === undefined) {
                        this.data.pengaturanAplikasi.biaya.max_usage_multiplier = defaultData.pengaturanAplikasi.biaya.max_usage_multiplier;
                    }

                    // NEW: Tambahkan properti logo jika belum ada
                    if (this.data.pengaturanAplikasi.logoBase64 === undefined) {
                         this.data.pengaturanAplikasi.logoBase64 = defaultData.pengaturanAplikasi.logoBase64;
                    }
                    
                    // NEW: Tambahkan properti rekening bank jika belum ada
                    if (this.data.pengaturanAplikasi.rekeningBank === undefined) {
                         this.data.pengaturanAplikasi.rekeningBank = defaultData.pengaturanAplikasi.rekeningBank;
                    }
                    
                    // Perbaiki status tagihan lama yang mungkin tidak memiliki status 'Menunggu Validasi'
                    this.data.tagihan = this.data.tagihan.map(t => {
                        if (t.sumber === 'mandiri' && t.status === 'Belum Lunas' && !t.tgl_validasi) {
                            // Tambahkan properti buktiFoto jika belum ada
                            return { ...t, status: 'Menunggu Validasi', buktiFoto: t.buktiFoto || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' };
                        }
                        if (t.sumber === 'mandiri' && !t.buktiFoto) {
                            return { ...t, buktiFoto: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=' };
                        }
                        return t;
                    });
                    this.data.pelanggan = this.data.pelanggan.map(p => ({...p, loginPin: p.loginPin || '1234'}));
                    // --- END MIGRASI DATA LAMA ---

                } else { 
                    this.data = defaultData; 
                    // Jika tidak ada data di localStorage, berarti ini adalah fresh start (atau data dihapus oleh browser)
                                // Simpan hanya saat pertama kali membuat data baru
                this.save();
} 
                this.save(); 
                
                // NEW DIAGNOSTIC ALERT
                const lastSave = this.data.metadata.lastSaveTimestamp;
                if(lastSave) {
                    const lastSaveDate = new Date(lastSave);
                    console.log(`[STATE] Data terakhir disimpan: ${lastSaveDate.toLocaleString()}`);
                }
            },
            save() { 
                // NEW: Update timestamp sebelum menyimpan
                this.data.metadata.lastSaveTimestamp = Date.now(); 
                localStorage.setItem('appData', JSON.stringify(this.data)); 
            },
            update(newState) { this.data = { ...this.data, ...newState }; this.save(); App.render(); },
            addGolongan(item) { this.update({ golongan: [...this.data.golongan, item] }); },
            updateGolongan(item) { this.update({ golongan: this.data.golongan.map(g => g.id === item.id ? item : g) }); },
            deleteGolongan(id) { this.update({ golongan: this.data.golongan.filter(g => g.id !== id) }); },
            addPelanggan(item) { this.update({ pelanggan: [...this.data.pelanggan, item] }); },
            updatePelanggan(item) { this.update({ pelanggan: this.data.pelanggan.map(p => p.id === item.id ? item : p) }); },
            deletePelanggan(id) { this.update({ pelanggan: this.data.pelanggan.filter(p => p.id !== id), tagihan: this.data.tagihan.filter(t => t.pelanggan_id !== id) }); },
            addTagihan(item) { this.update({ tagihan: [...this.data.tagihan, item] }); },
            updateTagihan(item) { this.update({ tagihan: this.data.tagihan.map(t => t.id === item.id ? item : t) }); },
            deleteTagihan(id) { this.update({ tagihan: this.data.tagihan.filter(t => t.id !== id) }); },
            
            addKasEntry(item) { this.update({ kas: [...this.data.kas, item] }); },
            updateKasEntry(item) { this.update({ kas: this.data.kas.map(k => k.id === item.id ? item : k) }); },
            deleteKasEntry(id) { 
                const updated = this.data.kas.filter(k => k.id !== id);
                this.update({ kas: updated }); 
            },
            
            // TAMBAH: User Management
            addUser(item) { this.update({ users: [...this.data.users, item] }); },
            updateUser(item) { this.update({ users: this.data.users.map(u => u.id === item.id ? item : u) }); },
            deleteUser(id) { this.update({ users: this.data.users.filter(u => u.id !== id) }); },

            // NEW: Validate Tagihan
            validateTagihan(id) {
                const updated = this.data.tagihan.map(t => { 
                    if (t.id === id && t.status === 'Menunggu Validasi') { 
                        return { ...t, status: 'Belum Lunas', tgl_validasi: Utils.getTodayDate() }; 
                    } 
                    return t; 
                }); 
                this.update({ tagihan: updated });
            },
            
            // FIX: Implement Auto-record Payment in Kas Umum, with more detail
            payTagihan(id, withDenda) { 
                const dendaAmount = withDenda ? State.data.pengaturanAplikasi.biaya.denda : 0;
                let kasEntryAdded = false;

                const updated = this.data.tagihan.map(t => { 
                    if (t.id === id) { 
                        // Pastikan tagihan siap dibayar (Belum Lunas), tidak Menunggu Validasi
                        if (t.status === 'Menunggu Validasi') return t;
                        
                        const finalTotal = Utils.calculateTagihanTotal(t.biaya_air, t.biaya_pemeliharaan, t.biaya_admin, dendaAmount);
                        const pelanggan = State.data.pelanggan.find(p => p.id === t.pelanggan_id);
                        const namaPelanggan = pelanggan ? pelanggan.nama : t.pelanggan_id;

                        // Deskripsi Kas Lebih Detail
                        let deskripsi = `Pbyr. Tagihan ${namaPelanggan} (${Utils.formatPeriode(t.periode)})`;
                        if (dendaAmount > 0) { deskripsi += ` + Denda`; }
                        
                        // Auto-record Payment in Kas Umum
                        const kasEntry = {
                            id: Utils.generateId('kas'),
                            tanggal: Utils.getTodayDate(),
                            tipe: 'MASUK',
                            deskripsi: deskripsi,
                            jumlah: finalTotal,
                            sumberTagihanId: t.id // Link back to tagihan ID
                        };
                        
                        // Hapus entri kas lama jika ada (untuk menghindari duplikasi jika proses pembayaran diulang/error)
                        this.data.kas = this.data.kas.filter(k => 
                            !(k.sumberTagihanId === t.id && k.tipe === 'MASUK')
                        );

                        this.data.kas = [...this.data.kas, kasEntry]; 
                        kasEntryAdded = true;

                        // UPDATE: Tambahkan no_pembayaran_id
                        return { ...t, status: 'Lunas', periodeBayar: Utils.getTodayDate(), total_tagihan: finalTotal, denda: dendaAmount, no_pembayaran: Utils.generateId('PAY') }; 
                    } 
                    return t; 
                }); 
                
                this.update({ tagihan: updated });
            },
            
            // FIX: Implement Cancel Payment removal from Kas Umum
            cancelPayment(id) { 
                const updated = this.data.tagihan.map(t => { 
                    if (t.id === id) { 
                        const originalTotal = Utils.calculateTagihanTotal(t.biaya_air, t.biaya_pemeliharaan, t.biaya_admin, 0);
                        return { 
                            ...t, 
                            status: t.sumber === 'mandiri' && t.tgl_validasi ? 'Belum Lunas' : (t.sumber === 'mandiri' ? 'Menunggu Validasi' : 'Belum Lunas'), // Perhatikan status kembali setelah dibatalkan
                            periodeBayar: undefined, 
                            total_tagihan: originalTotal, 
                            denda: 0,
                            no_pembayaran: undefined // Hapus No Pembayaran
                        }; 
                    } 
                    return t; 
                }); 
                
                // Remove the corresponding Kas entry
                this.data.kas = this.data.kas.filter(k => 
                    !(k.sumberTagihanId === id && k.tipe === 'MASUK')
                );
                
                this.update({ tagihan: updated }); 
            },
            
            // NEW UTILITY: Mencari Tagihan Terakhir (untuk konsistensi)
            getLatestTagihan: (pId) => {
                 return State.data.tagihan
                    .filter(t => t.pelanggan_id === pId && t.status !== 'Menunggu Validasi')
                    .sort((a, b) => b.periode.localeCompare(a.periode))[0];
            }
        };

        const Render = {
            chartInstances: {}, // Untuk menyimpan instance Chart.js
            all() { this.appSettings(); if(Auth.mode === 'admin') this.renderAdminSections(); else if(Auth.mode === 'customer') Handlers.renderCustomerPortal(); },
            renderAdminSections() { this.dashboard(); this.golongan(); this.pelanggan(); this.tagihan(); this.administrasi(); this.kasUmum(); this.users(); }, 
            appSettings() { 
                const j = State.data.pengaturanAplikasi.judulAplikasi; 
                UI.elements.appTitle.textContent = j; 
                UI.elements.headerTitle.textContent = j; 
                
                // PERBAIKAN ERROR LOGIC: Gunakan innerHTML agar tag ikon di-parse dengan benar
                UI.elements.loginTitle.innerHTML = `<i class="fa-solid fa-lock" style="margin-right: 10px;"></i> Login ${j}`; 
                
                if (UI.elements.customerHeaderTitle) UI.elements.customerHeaderTitle.textContent = `Portal Pelanggan ${j}`;
                UI.elements.inputJudulAplikasi.value = j; 
                UI.elements.splashScreen.querySelector('#splash-title').textContent = `${j} Loading...`;

                // NEW: Load Logo Preview
                const logo = State.data.pengaturanAplikasi.logoBase64;
                if (logo && UI.elements.previewLogo) {
                    UI.elements.previewLogo.src = logo;
                    UI.elements.previewLogo.style.display = 'block';
                } else if (UI.elements.previewLogo) {
                    UI.elements.previewLogo.style.display = 'none';
                    UI.elements.previewLogo.src = '';
                }
                
                // NEW: Isi Opsi Tahun di Filter Tagihan
                const currentYear = new Date().getFullYear();
                let yearOptions = '<option value="">Semua Tahun</option>';
                for (let y = currentYear; y >= currentYear - 5; y--) {
                    yearOptions += `<option value="${y}">${y}</option>`;
                }
                UI.elements.filterTagihanTahun.innerHTML = yearOptions;
                // Tidak perlu set default di sini, akan di set di App.setDefaultLaporanDate
            },
            dashboard() { 
                const { p, t } = {p: State.data.pelanggan, t: State.data.tagihan}; 
                const cM = Utils.getCurrentPeriode();
                // Perhitungkan tagihan yang menunggu validasi sebagai tunggakan
                const tTerbayar = t.filter(i => i.status === 'Lunas' && i.periodeBayar?.startsWith(cM)).reduce((s, i) => s + i.total_tagihan, 0); 
                const tTunggakan = t.filter(i => i.status === 'Belum Lunas' || i.status === 'Menunggu Validasi').reduce((s, i) => s + i.total_tagihan, 0); 
                
                UI.elements.statJmlPelanggan.textContent = p.length; 
                UI.elements.statTotalTerbayar.textContent = Utils.formatCurrency(tTerbayar); 
                UI.elements.statTotalTunggakan.textContent = Utils.formatCurrency(tTunggakan); 
                
                // NEW: Tampilkan periode terbayar
                UI.elements.statPeriodeTerbayar.textContent = `(${Utils.formatPeriode(cM)})`;
                
                // NEW: Render Charts
                this.renderPemasukanChart();
                this.renderPelangganGolonganChart();
                this.renderPemakaianAirChart();
            },
            
            // NEW: Fungsi untuk membuat chart Total Pemasukan
            renderPemasukanChart() {
                // Pastikan Chart.js sudah termuat
                if (!window.Chart) return;
                
                const periods = Utils.get12MonthsAgo();
                const labels = periods.map(Utils.formatMonthYear);
                const data = periods.map(p => {
                    const kasEntries = State.data.kas.filter(k => k.tipe === 'MASUK' && k.tanggal.startsWith(p));
                    // Pastikan kasEntries adalah array yang valid sebelum reduce
                    if (!Array.isArray(kasEntries)) return 0;
                    return kasEntries.reduce((sum, k) => sum + k.jumlah, 0);
                });

                if (this.chartInstances.pemasukan) this.chartInstances.pemasukan.destroy();

                this.chartInstances.pemasukan = new Chart(UI.elements.chartPemasukanCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Pemasukan (IDR)',
                            data: data,
                            backgroundColor: 'rgba(255, 165, 0, 0.7)',
                            borderColor: 'orange',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            },
            
            // NEW: Fungsi untuk membuat chart Pelanggan per Golongan
            renderPelangganGolonganChart() {
                if (!window.Chart) return;
                
                const golonganMap = {};
                State.data.golongan.forEach(g => golonganMap[g.id] = { name: g.nama, count: 0 });
                State.data.pelanggan.forEach(p => {
                    if (golonganMap[p.golonganId]) {
                        golonganMap[p.golonganId].count++;
                    }
                });

                const labels = Object.values(golonganMap).map(g => g.name);
                const data = Object.values(golonganMap).map(g => g.count);

                const backgroundColors = labels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`); // Warna berdasar HSL

                if (this.chartInstances.pelanggan) this.chartInstances.pelanggan.destroy();

                this.chartInstances.pelanggan = new Chart(UI.elements.chartPelangganGolonganCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                    }
                });
            },
            
            // NEW: Fungsi untuk membuat chart Tren Pemakaian Air
            renderPemakaianAirChart() {
                if (!window.Chart) return;
                
                const periods = Utils.get12MonthsAgo().slice(6); // 6 bulan terakhir
                const labels = periods.map(Utils.formatMonthYear);
                const pemakaianData = periods.map(p => {
                    return State.data.tagihan
                        .filter(t => t.periode === p && t.status === 'Lunas')
                        .reduce((sum, t) => sum + t.pemakaian, 0);
                });

                if (this.chartInstances.pemakaian) this.chartInstances.pemakaian.destroy();

                this.chartInstances.pemakaian = new Chart(UI.elements.chartPemakaianAirCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Pemakaian Air (m¬≥)',
                            data: pemakaianData,
                            backgroundColor: 'rgba(23, 162, 184, 0.2)',
                            borderColor: 'rgba(23, 162, 184, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },
            
            golongan() { 
                const data = State.data.golongan;
                if (data.length === 0) {
                    UI.elements.tabelGolonganBody.innerHTML = '<tr><td colspan="4" class="empty-table-message">Tidak ada data Golongan. Silakan tambahkan data baru.</td></tr>';
                    return;
                }
                UI.elements.tabelGolonganBody.innerHTML = data.map(g => `<tr><td>${g.id}</td><td>${g.nama}</td><td>${Utils.formatCurrency(g.tarif)}</td><td class="action-buttons"><button class="btn-secondary" data-action="edit" data-id="${g.id}">Edit</button><button class="btn-danger" data-action="delete" data-id="${g.id}">Hapus</button></td></tr>`).join(''); 
            },
            pelanggan() { 
                const sT = UI.elements.searchPelanggan.value.toLowerCase(); 
                const f = State.data.pelanggan.filter(p => p.nama.toLowerCase().includes(sT) || p.id.toLowerCase().includes(sT)); 
                
                if (f.length === 0) {
                    UI.elements.tabelPelangganBody.innerHTML = '<tr><td colspan="6" class="empty-table-message">Tidak ada data Pelanggan yang sesuai.</td></tr>';
                    return;
                }

                // NEW: Use truncate-text for Alamat (Suggestion 3)
                // IMPROVEMENT: Masking PIN
                UI.elements.tabelPelangganBody.innerHTML = f.map(p => { 
                    const g = State.data.golongan.find(gol => gol.id === p.golonganId); 
                    return `<tr>
                        <td>${p.id}</td>
                        <td>${p.nama}</td>
                        <td class="truncate-text" title="${p.alamat}">${p.alamat}</td>
                        <td>${g ? g.nama : 'N/A'}</td>
                        <td>${p.loginPin ? '*'.repeat(p.loginPin.length) : 'N/A'}</td>
                        <td class="action-buttons"><button class="btn-secondary" data-action="edit" data-id="${p.id}">Edit</button><button class="btn-danger" data-action="delete" data-id="${p.id}">Hapus</button></td>
                    </tr>`; 
                }).join(''); 
            },
            tagihan() {
                const { p, t } = {p: State.data.pelanggan, t: State.data.tagihan}; 
                const fS = UI.elements.filterTagihanStatus.value;
                
                // NEW: Ambil nilai filter bulan dan tahun
                const filterBulan = UI.elements.filterTagihanBulan.value; // YYYY-MM
                const filterTahun = UI.elements.filterTagihanTahun.value; // YYYY
                
                // Filter berdasarkan status yang dipilih, bulan, dan tahun
                const f = t.filter(item => {
                    const statusMatch = fS === 'semua' || item.status === fS;
                    
                    // Filter berdasarkan bulan (YYYY-MM)
                    let periodeMatch = true;
                    if (filterBulan) {
                        periodeMatch = item.periode === filterBulan;
                    } 
                    // Jika filter bulan kosong, filter berdasarkan tahun (YYYY)
                    else if (filterTahun && filterTahun !== 'semua') {
                        periodeMatch = item.periode.startsWith(filterTahun);
                    }
                    
                    return statusMatch && periodeMatch;
                }).sort((a,b) => b.periode.localeCompare(a.periode)); // Urutkan berdasarkan periode terbaru
                
                // Hitung Rekapan Global (Rekapan di bagian atas tetap menunjukkan total keseluruhan)
                const totalBelumLunas = t
                    .filter(item => item.status === 'Belum Lunas')
                    .reduce((sum, item) => sum + item.total_tagihan, 0);
                const totalPending = t
                    .filter(item => item.status === 'Menunggu Validasi')
                    .reduce((sum, item) => sum + item.total_tagihan, 0);
                const totalLunasSemua = t
                                        .filter(item => item.status === 'Lunas')
                                        .reduce((sum, item) => sum + item.total_tagihan, 0);
                
                // Tampilkan Rekapan 
                UI.elements.statTagihanBelumLunas.textContent = Utils.formatCurrency(totalBelumLunas);
                UI.elements.statTagihanPending.textContent = Utils.formatCurrency(totalPending);
                UI.elements.statTagihanLunas.textContent = Utils.formatCurrency(totalLunasSemua);

                // Tambah option filter 'Menunggu Validasi' jika belum ada
                if (!UI.elements.filterTagihanStatus.querySelector('option[value="Menunggu Validasi"]')) {
                    UI.elements.filterTagihanStatus.insertAdjacentHTML('beforeend', '<option value="Menunggu Validasi">Menunggu Validasi</option>');
                }
                
                if (f.length === 0) {
                    UI.elements.tabelTagihanBody.innerHTML = '<tr><td colspan="8" class="empty-table-message">Tidak ada data Tagihan yang sesuai dengan filter.</td></tr>';
                    return;
                }
                
                // Get current user role safely
                const role = Auth.currentUser?.role;
                const isPetugas = role === 'petugas' || role === 'full';
                const isFullAdmin = role === 'full';

                // Refactored: Gunakan Handlers.generateTagihanActionButtons
                UI.elements.tabelTagihanBody.innerHTML = f.map(item => { 
                    const pl = p.find(pel => pel.id === item.pelanggan_id); if (!pl) return ''; 
                    
                    const aB = Handlers.generateTagihanActionButtons(item, isPetugas, isFullAdmin);
                    
                    let statusClass = 'status-belum';
                    if (item.status === 'Lunas') statusClass = 'status-lunas';
                    else if (item.status === 'Menunggu Validasi') statusClass = 'status-pending';
                    
                    const sumberText = item.sumber === 'mandiri' ? 'Mandiri' : 'Staf';
                    return `<tr><td>${pl.id}</td><td>${pl.nama}</td><td>${Utils.formatPeriode(item.periode)}</td><td>${item.pemakaian}</td><td>${sumberText}</td><td>${Utils.formatCurrency(item.total_tagihan)}</td><td class="${statusClass}">${item.status}</td><td class="action-buttons">${aB}</td></tr>`;
                }).join('');
            },
            inputBayarResults(customer, bills) { const c = UI.elements.bayarHasilPencarian; c.style.display = 'block'; if (!customer) { c.innerHTML = '<p class="status-belum">Pelanggan tidak ditemukan.</p>'; return; } 
                const readyBills = bills.filter(b => b.status === 'Belum Lunas');
                const pendingBills = bills.filter(b => b.status === 'Menunggu Validasi');
                
                let h = `<h3>Detail Pelanggan</h3><p><strong>ID:</strong> ${customer.id}<br><strong>Nama:</strong> ${customer.nama}<br><strong>Alamat:</strong> ${customer.alamat}</p><hr>`;
                
                // Get current user role safely
                const role = Auth.currentUser?.role;
                const isPetugas = role === 'petugas' || role === 'full';

                if (readyBills.length === 0 && pendingBills.length === 0) { 
                    h += '<h3>Tagihan Belum Lunas</h3><p class="status-lunas">Tidak ada tagihan yang belum lunas (siap dibayar).</p>'; 
                } else {
                    if (readyBills.length > 0) {
                        h += '<h3>Tagihan Siap Bayar</h3>';
                        h += `<div class="table-responsive"><table><thead><tr><th>Periode</th><th>Total</th><th>Aksi</th></tr></thead><tbody>`; 
                        readyBills.sort((a,b) => a.periode.localeCompare(b.periode)).forEach(bill => { h += `<tr><td>${Utils.formatPeriode(bill.periode)}</td><td>${Utils.formatCurrency(bill.total_tagihan)}</td><td><button class="btn-success" data-action="pay" data-id="${bill.id}"><i class="fa-solid fa-money-bill-wave" style="margin-right: 5px;"></i> Bayar</button></td></tr>`; }); 
                        h += `</tbody></table></div>`;
                    }
                    if (pendingBills.length > 0) {
                        h += '<h3>Tagihan Menunggu Validasi (Mandiri)</h3>';
                        h += `<div class="table-responsive"><table><thead><tr><th>Periode</th><th>Total</th><th>Aksi</th></tr></thead><tbody>`; 
                        pendingBills.sort((a,b) => a.periode.localeCompare(b.periode)).forEach(bill => { 
                            const buktiBtn = (bill.status === 'Menunggu Validasi' && bill.buktiFoto) ? `<button class="btn-secondary" data-action="view-foto" data-id="${bill.id}"><i class="fa-solid fa-camera" style="margin-right: 5px;"></i> Lihat Foto</button>` : '';
                            const validationBtn = isPetugas ? `<button class="btn-primary" data-action="validate" data-id="${bill.id}"><i class="fa-solid fa-check" style="margin-right: 5px;"></i> Validasi</button>` : `<button class="btn-primary" disabled>Validasi</button>`;
                            h += `<tr><td>${Utils.formatPeriode(bill.periode)}</td><td>${Utils.formatCurrency(bill.total_tagihan)}</td><td>${buktiBtn} ${validationBtn}</td></tr>`; 
                        }); 
                        h += `</tbody></table></div>`;
                    }
                }

                h += '<br><button id="btn-reset-bayar" class="btn-secondary">Tutup</button>'; 
                c.innerHTML = h; 
                // Karena tombol di sini dinamis, perlu dilampirkan kembali event listener tagihanAction
                c.querySelectorAll('button[data-action]').forEach(btn => {
                     btn.addEventListener('click', (e) => Handlers.tagihanAction.call(Handlers, { target: e.target }));
                });
                document.getElementById('btn-reset-bayar').addEventListener('click', Handlers.resetInputBayar); 
            },
            // UPDATED: Include max_usage_multiplier (Suggestion 4) dan rekeningBank
            administrasi() { 
                const { biaya, rekeningBank } = State.data.pengaturanAplikasi; // Ambil juga rekeningBank
                document.getElementById('biaya-pemeliharaan').value = biaya.pemeliharaan; 
                document.getElementById('biaya-administrasi').value = biaya.administrasi; 
                document.getElementById('biaya-denda').value = biaya.denda; 
                document.getElementById('max-usage-multiplier').value = biaya.max_usage_multiplier; 
                
                // NEW: Load Rekening Bank
                UI.elements.inputNamaBank.value = rekeningBank.namaBank;
                UI.elements.inputNomorRekening.value = rekeningBank.nomorRekening;
                UI.elements.inputNamaPemilikRekening.value = rekeningBank.namaPemilikRekening;
                
                // Load Logo Preview
                const logo = State.data.pengaturanAplikasi.logoBase64;
                if (logo && UI.elements.previewLogo) {
                    UI.elements.previewLogo.src = logo;
                    UI.elements.previewLogo.style.display = 'block';
                } else if (UI.elements.previewLogo) {
                    UI.elements.previewLogo.style.display = 'none';
                    UI.elements.previewLogo.src = '';
                }
            },
            
            // Perbaikan Logika BKU Sorting & Filtering
            kasUmum() { 
                const filterType = UI.elements.kasTipeFilter.value;
                let filterPeriodStart = null;
                let filterPeriodEnd = null;
                
                // Amankan akses role (perlu karena dipanggil saat navigasi)
                const role = Auth.currentUser?.role; 
                const isKeuangan = role === 'keuangan' || role === 'full';
                
                // Jika belum login admin, jangan proses data BKU
                if (!Auth.loggedAdmin) { 
                    UI.elements.tabelKasUmumBody.innerHTML = '<tr><td colspan="7" class="empty-table-message">Silakan login sebagai Admin/Keuangan untuk melihat Buku Kas Umum.</td></tr>';
                    return; 
                } 

                // Determine filter range based on filterType
                if (filterType === 'bulanan' && UI.elements.kasBulanInput.value) {
                    filterPeriodStart = UI.elements.kasBulanInput.value;
                    filterPeriodEnd = UI.elements.kasBulanInput.value;
                } else if (filterType === 'tahunan' && UI.elements.kasTahunInput.value) {
                    filterPeriodStart = UI.elements.kasTahunInput.value;
                    filterPeriodEnd = UI.elements.kasTahunInput.value;
                } else if (filterType === 'rentang' && UI.elements.kasFromInput.value && UI.elements.kasToInput.value) {
                    filterPeriodStart = UI.elements.kasFromInput.value;
                    filterPeriodEnd = UI.elements.kasToInput.value;
                }
                
                // Filter dan Sort: Urutkan berdasarkan tanggal, lalu berdasarkan ID (timestamp) sebagai urutan sekunder (waktu)
                let allKasDataSorted = State.data.kas.sort((a,b) => {
                    const dateA = a.tanggal;
                    const dateB = b.tanggal;
                    if (dateA !== dateB) return dateA.localeCompare(dateB);
                    // Ambil waktu dari ID
                    const timeA = parseInt(a.id.replace('kas', '')) || 0;
                    const timeB = parseInt(b.id.replace('kas', '')) || 0;
                    return timeA - timeB;
                }); 
                
                // 1. Calculate the starting balance (saldo before the filter period)
                let saldoAwal = 0;
                let kasData = allKasDataSorted;
                
                if (filterType !== 'semua' && filterPeriodStart) {
                    const firstFilteredIndex = allKasDataSorted.findIndex(k => {
                        // Logic for filtering
                        if (filterType === 'bulanan' || filterType === 'tahunan') {
                             return k.tanggal.startsWith(filterPeriodStart);
                        } else if (filterType === 'rentang') {
                             return k.tanggal >= filterPeriodStart && k.tanggal <= filterPeriodEnd;
                        }
                        return false;
                    });
                    
                    if (firstFilteredIndex > 0) {
                         allKasDataSorted
                            .slice(0, firstFilteredIndex)
                            .forEach(k => {
                                if (k.tipe === 'MASUK') saldoAwal += k.jumlah;
                                else saldoAwal -= k.jumlah;
                            });
                    }
                    
                    // Apply actual filter to display data
                    if (filterType === 'bulanan' || filterType === 'tahunan') {
                         kasData = allKasDataSorted.filter(k => k.tanggal.startsWith(filterPeriodStart));
                    } else if (filterType === 'rentang') {
                         kasData = allKasDataSorted.filter(k => k.tanggal >= filterPeriodStart && k.tanggal <= filterPeriodEnd);
                    }
                }
                
                let totalMasuk = 0;
                let totalKeluar = 0;
                let saldoAkumulasi = saldoAwal;

                let tableRows = '';
                
                // NEW: Handle Empty Table (Suggestion 7)
                if (kasData.length === 0 && filterType !== 'semua' && filterPeriodStart) {
                    let periodText = '';
                    if (filterType === 'bulanan') periodText = Utils.formatPeriode(filterPeriodStart);
                    else if (filterType === 'tahunan') periodText = filterPeriodStart;
                    else if (filterType === 'rentang') periodText = `${Utils.formatDateShort(filterPeriodStart)} s/d ${Utils.formatDateShort(filterPeriodEnd)}`;
                    
                    tableRows = `<tr><td colspan="7" class="empty-table-message">Tidak ada Transaksi Kas pada periode ${periodText}.</td></tr>`;
                    
                } else if (kasData.length === 0 && filterType === 'semua') {
                     tableRows = `<tr><td colspan="7" class="empty-table-message">Belum ada Transaksi Kas yang tercatat.</td></tr>`;
                } else {
                    
                    // Add Saldo Awal row if filtered
                    if (filterType !== 'semua') {
                        let periodText = '';
                        if (filterType === 'bulanan') periodText = Utils.formatPeriode(filterPeriodStart);
                        else if (filterType === 'tahunan') periodText = filterPeriodStart;
                        else if (filterType === 'rentang') periodText = `${Utils.formatDateShort(filterPeriodStart)} s/d ${Utils.formatDateShort(filterPeriodEnd)}`;
                        
                        // IMPROVEMENT: Add saldo-awal-row class
                        tableRows += `
                            <tr class="saldo-awal-row">
                                <td></td>
                                <td colspan="4">SALDO AWAL ${periodText.toUpperCase()}</td>
                                <td>${Utils.formatCurrency(saldoAwal)}</td>
                                <td></td>
                            </tr>
                        `;
                    }

                    // 2. Iterate and render the filtered data
                    kasData.forEach(k => { 
                        const isMasuk = k.tipe === 'MASUK';
                        const amount = k.jumlah;
                        const date = k.tanggal;
                        // FIX: Ambil waktu dari ID (timestamp)
                        const time = new Date(parseInt(k.id.replace('kas', ''))).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        
                        const isTagihanPayment = !!k.sumberTagihanId;
                        
                        if (isMasuk) {
                            totalMasuk += amount;
                            saldoAkumulasi += amount;
                        } else {
                            totalKeluar += amount;
                            saldoAkumulasi -= amount;
                        }
                        
                        // Logika tombol Aksi
                        let actionButtons = '';
                        if (isTagihanPayment) {
                            actionButtons = `<button class="btn-secondary" disabled title="Pembayaran tagihan tidak bisa diedit/dihapus langsung di BKU.">Otomatis</button>`;
                        } else {
                            // Non-otomatis, bisa diedit/dihapus (hanya oleh Full Admin/Keuangan)
                            if (isKeuangan) { 
                                actionButtons = `
                                    <button class="btn-secondary" data-action="edit" data-id="${k.id}">Edit</button>
                                    <button class="btn-danger" data-action="delete" data-id="${k.id}">Hapus</button>
                                `;
                            } else {
                                actionButtons = `<button class="btn-secondary" disabled>Tidak Diizinkan</button>`;
                            }
                        }

                        // NEW: Use truncate-text for Deskripsi (Suggestion 3)
                        tableRows += `<tr>
                            <td>${Utils.formatDateID(date)}</td>
                            <td>${time}</td>
                            <td class="truncate-text" title="${k.deskripsi}">${k.deskripsi}</td>
                            <td style="color:var(--success-color);">${isMasuk ? Utils.formatCurrency(amount) : '-'}</td>
                            <td style="color:var(--danger-color);">${!isMasuk ? Utils.formatCurrency(amount) : '-'}</td>
                            <td>${Utils.formatCurrency(saldoAkumulasi)}</td>
                            <td class="action-buttons">${actionButtons}</td>
                        </tr>`;
                    });
                    
                    // Add baris total
                    tableRows += `
                        <tr>
                            <td colspan="3">TOTAL KESELURUHAN</td>
                            <td>${Utils.formatCurrency(totalMasuk)}</td>
                            <td>${Utils.formatCurrency(totalKeluar)}</td>
                            <td>${Utils.formatCurrency(saldoAkumulasi)}</td>
                            <td></td>
                        </tr>
                    `;
                }

                UI.elements.tabelKasUmumBody.innerHTML = tableRows;

                UI.elements.statKasMasuk.textContent = Utils.formatCurrency(totalMasuk); 
                UI.elements.statKasKeluar.textContent = Utils.formatCurrency(totalKeluar);
                UI.elements.statSaldoAkhir.textContent = Utils.formatCurrency(saldoAkumulasi);
            },
            
            // TAMBAH: Render User Management
            users() { 
                const data = State.data.users;
                if (data.length === 0) {
                     UI.elements.tabelUserBody.innerHTML = '<tr><td colspan="4" class="empty-table-message">Tidak ada data User Admin.</td></tr>';
                     return;
                }
                // Menampilkan Role/Peran
                UI.elements.tabelUserBody.innerHTML = data.map(u => {
                    const isDefaultAdmin = u.username === 'admin';
                    const roleText = u.role.charAt(0).toUpperCase() + u.role.slice(1);
                    let actionButtons = '';
                    if (!isDefaultAdmin) {
                        actionButtons = `<button class="btn-secondary" data-action="edit" data-id="${u.id}">Edit</button><button class="btn-danger" data-action="delete" data-id="${u.id}">Hapus</button>`;
                    } else {
                        actionButtons = `<button class="btn-secondary" data-action="edit" data-id="${u.id}">Edit</button><button class="btn-secondary" disabled>Admin Utama</button>`;
                    }
                    return `<tr><td>${u.username}</td><td>${u.namaLengkap}</td><td>${roleText}</td><td class="action-buttons">${actionButtons}</td></tr>`;
                }).join('');
            },

            // NEW: Render Rekening Pembayaran
            rekeningPembayaran() {
                const { namaBank, nomorRekening, namaPemilikRekening } = State.data.pengaturanAplikasi.rekeningBank;
                
                let html = '';
                if (nomorRekening && namaPemilikRekening) {
                    html = `
                        <h3 style="color: var(--primary-dark); margin-top: 0;">${namaBank}</h3>
                        <div style="font-size: 1.5em; margin-bottom: 10px; font-weight: bold; padding: 10px; background-color: white; border: 1px solid #ddd; border-radius: 4px; display:flex; align-items:center; justify-content:space-between;">
                            <span>${nomorRekening}</span>
                            <i class="fa-regular fa-copy" style="cursor: pointer; margin-left: 10px; font-size: 0.7em;" title="Salin Nomor Rekening"></i>
                        </div>
                        <p style="font-size: 1.2em;">A.N. <strong style="color: var(--success-color);">${namaPemilikRekening}</strong></p>
                    `;
                } else {
                    html = '<p class="status-belum">Mohon maaf, informasi rekening pembayaran belum dikonfigurasi oleh Admin.</p>';
                }
                
                UI.elements.rekeningDisplay.innerHTML = html;
                
                // Tambahkan event listener untuk tombol salin (Copy to Clipboard)
                const copyBtn = UI.elements.rekeningDisplay.querySelector('.fa-copy');
                if (copyBtn) {
                     copyBtn.addEventListener('click', () => {
                        // Menggunakan API modern untuk menyalin
                        navigator.clipboard.writeText(nomorRekening)
                            .then(() => UI.showToast('Nomor rekening berhasil disalin!'))
                            .catch(() => UI.showToast('Gagal menyalin. Silakan salin manual.'));
                     });
                }
            },
        };

        const Handlers = {
            // NEW UTILITY: Hasilkan tombol aksi untuk tabel tagihan (Refactoring #1)
            generateTagihanActionButtons(tagihan, isPetugas, isFullAdmin) {
                let aB = '';
                
                // Tombol Lihat Foto (Semua Admin)
                const buktiBtn = (tagihan.status === 'Menunggu Validasi' && tagihan.buktiFoto) 
                                 ? `<button class="btn-secondary btn-sm" data-action="view-foto" data-id="${tagihan.id}"><i class="fa-solid fa-camera"></i> Foto</button>` 
                                 : '';

                if (tagihan.status === 'Lunas') { 
                    aB = `<button class="btn-primary btn-sm" data-action="print" data-id="${tagihan.id}"><i class="fa-solid fa-print"></i> Cetak</button>`;
                    // Tombol Batal Bayar dan Edit Tgl Bayar hanya untuk Full Admin
                    if (isFullAdmin) {
                        aB += `<button class="btn-secondary btn-sm" data-action="edit" data-id="${tagihan.id}"><i class="fa-solid fa-calendar-days"></i> Edit Tgl</button><button class="btn-danger btn-sm" data-action="cancel-pay" data-id="${tagihan.id}"><i class="fa-solid fa-xmark"></i> Batal</button>`;
                    }
                } else if (tagihan.status === 'Belum Lunas') { 
                    aB = `<button class="btn-success btn-sm" data-action="pay" data-id="${tagihan.id}"><i class="fa-solid fa-money-bill-wave"></i> Bayar</button>`;
                    // Tombol Edit/Hapus hanya untuk Petugas/Full Admin
                    if (isPetugas) {
                        aB += `<button class="btn-secondary btn-sm" data-action="edit" data-id="${tagihan.id}">Edit</button><button class="btn-danger btn-sm" data-action="delete" data-id="${tagihan.id}"><i class="fa-solid fa-trash-can"></i> Hapus</button>`;
                    }
                } else if (tagihan.status === 'Menunggu Validasi') { 
                    // Tombol Edit/Lihat hanya untuk Petugas/Full Admin
                    const validationActions = isPetugas 
                        ? `<button class="btn-primary btn-sm" data-action="validate" data-id="${tagihan.id}"><i class="fa-solid fa-check"></i> Validasi</button><button class="btn-danger btn-sm" data-action="delete" data-id="${tagihan.id}"><i class="fa-solid fa-trash-can"></i> Hapus</button>` 
                        : `<button class="btn-secondary btn-sm" disabled>Tunggu</button>`;
                        
                    // Tombol Edit/Lihat di sini hanya untuk membuka modal (Lihat data meteran)
                    aB = `${buktiBtn} <button class="btn-secondary btn-sm" data-action="edit" data-id="${tagihan.id}">Lihat</button> ${validationActions}`;
                }
                return aB;
            },
            // END Refactoring Aksi Tabel
            
            // ADMIN HANDLERS
            loginSubmit(e) { 
                e.preventDefault(); 
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Login Admin'); // Suggestion 5: Set loading state

                const u = UI.elements.loginForm.username.value, p = UI.elements.loginForm.password.value; 
                
                // Introduce a slight delay for better UX on button feedback
                setTimeout(() => Auth.loginAdmin(u, p, btn), 500); 
            },
            
            // NEW: Apply role restrictions
            applyRoleRestrictions(role) {
                // Sembunyikan semua tombol aksi yang memerlukan role tertentu
                document.querySelectorAll('.main-app .nav-link').forEach(el => {
                    const allowedRoles = el.dataset.role.split(',');
                    if (allowedRoles.includes(role)) {
                        el.classList.remove('hidden-role');
                    } else {
                        el.classList.add('hidden-role');
                        // Jika menu yang aktif adalah menu yang tersembunyi, pindah ke dashboard
                        if(el.classList.contains('active')) {
                             // Simulasi klik dashboard
                             document.querySelector('[data-target="dashboard"]').click();
                        }
                    }
                });
                
                // Sembunyikan tombol 'Tambah' yang spesifik
                if (role !== 'full') {
                    // Hanya full admin yang bisa tambah user/golongan/admin
                    const btnTambahGolongan = document.getElementById('btn-tambah-golongan');
                    const btnTambahUser = document.getElementById('btn-tambah-user');
                    if(btnTambahGolongan) btnTambahGolongan.style.display = 'none';
                    if(btnTambahUser) btnTambahUser.style.display = 'none';
                } else {
                    const btnTambahGolongan = document.getElementById('btn-tambah-golongan');
                    const btnTambahUser = document.getElementById('btn-tambah-user');
                    if(btnTambahGolongan) btnTambahGolongan.style.display = 'inline-flex';
                    if(btnTambahUser) btnTambahUser.style.display = 'inline-flex';
                }
                
                // Jika bukan Full Admin atau Petugas, sembunyikan tombol buat tagihan
                const btnBuatTagihan = document.getElementById('btn-buat-tagihan');
                if (btnBuatTagihan) {
                    if (role !== 'full' && role !== 'petugas') {
                         btnBuatTagihan.style.display = 'none';
                    } else {
                        btnBuatTagihan.style.display = 'inline-flex';
                    }
                }
            },
            
            // NEW: Check for impending due dates and show dashboard notification
            checkJatuhTempoNotification() {
                // Hanya tampilkan notifikasi jika role adalah 'full' atau 'petugas'
                if (Auth.currentUser?.role !== 'full' && Auth.currentUser?.role !== 'petugas') return;
                
                const today = new Date();
                let countWarning = 0;
                let countOverdue = 0;

                State.data.tagihan.forEach(t => {
                    if (t.status === 'Belum Lunas' || t.status === 'Menunggu Validasi') {
                        const [y, m] = t.periode.split('-');
                        const dueDate = new Date(parseInt(y), parseInt(m), 1); // Jatuh tempo tanggal 1 bulan berikutnya (asumsi)
                        
                        // Tambahkan 1 bulan ke periode tagihan untuk menentukan jatuh tempo
                        dueDate.setMonth(dueDate.getMonth() + 1); 
                        
                        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (diffDays < 0) {
                            countOverdue++;
                        } else if (diffDays <= 7) {
                            countWarning++;
                        }
                    }
                });
                
                const notificationArea = UI.elements.dashboardNotificationArea;
                notificationArea.style.display = 'none';
                notificationArea.classList.remove('alert-danger', 'alert-warning');
                notificationArea.innerHTML = '';

                if (countOverdue > 0) {
                     notificationArea.classList.add('alert-danger');
                     notificationArea.innerHTML = `<strong>‚ö†Ô∏è ${countOverdue} Tagihan Sudah Jatuh Tempo!</strong> Segera tindak lanjuti.`;
                     notificationArea.style.display = 'flex';
                } else if (countWarning > 0) {
                     notificationArea.classList.add('alert-warning');
                     notificationArea.innerHTML = `<strong>üîî ${countWarning} Tagihan Akan Jatuh Tempo</strong> dalam 7 hari.`;
                     notificationArea.style.display = 'flex';
                }
            },
            
            navigation(e) { 
                e.preventDefault(); 
                const t = e.target.dataset.target; 
                UI.elements.navLinks.forEach(l => l.classList.remove('active')); 
                UI.elements.contentSections.forEach(s => s.classList.remove('active')); 
                e.target.classList.add('active'); 
                document.getElementById(t).classList.add('active');
                if (t === 'dashboard') Render.dashboard(); // Render ulang chart
                else if (t === 'golongan') Render.golongan();
                else if (t === 'pelanggan') Render.pelanggan();
                else if (t === 'tagihan') Render.tagihan();
                else if (t === 'kas-umum') Render.kasUmum(); 
                else if (t === 'manajemen-user') Render.users(); // Panggil Render User
                else if (t === 'administrasi') Render.administrasi();
                else if (t === 'input-bayar') Handlers.resetInputBayar();
            },
            savePelanggan(e) { 
                e.preventDefault(); 
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Simpan'); // Suggestion 5: Set loading state

                const f = UI.elements.formPelanggan, idEdit = f.querySelector('#pelanggan-id-edit').value, noP = f.querySelector('#nomor_pelanggan').value.trim(), n = f.querySelector('#nama_pelanggan').value.trim(), a = f.querySelector('#alamat_pelanggan').value.trim(), gId = UI.elements.selectGolonganPelanggan.value;
                const pin = f.querySelector('#pin_pelanggan').value.trim();

                if (!noP || !n || !a || !gId) { setButtonState(btn, false, 'Simpan'); return UI.showToast('Semua kolom wajib diisi!'); }
                
                if (pin && (pin.length !== 4 || !/^\d{4}$/.test(pin))) {
                    setButtonState(btn, false, 'Simpan'); 
                    return UI.showToast('PIN Pelanggan harus 4 digit angka!');
                }

                if (idEdit) { 
                    const existingPin = State.data.pelanggan.find(p => p.id === idEdit)?.loginPin;
                    State.updatePelanggan({ id: idEdit, nama: n, alamat: a, golonganId: gId, loginPin: pin || existingPin }); 
                    UI.showToast('Pelanggan diperbarui!'); 
                } else { 
                    if (State.data.pelanggan.some(p => p.id === noP)) { setButtonState(btn, false, 'Simpan'); return UI.showToast('Nomor pelanggan sudah ada!'); }
                    State.addPelanggan({ id: noP, nama: n, alamat: a, golonganId: gId, loginPin: pin || '1234' }); 
                    UI.showToast('Pelanggan ditambahkan! PIN Default: 1234'); 
                } 
                UI.closeAllModals(); 
                setButtonState(btn, false, 'Simpan');
            },
            
            // PERBAIKAN: Logika Auto-fill Meter Awal
            setupTagihanMeterAutoFill: (e) => {
                const pId = e.target.value;
                const form = UI.elements.formTagihan;
                const meterAwalInput = form.querySelector('#meter_awal');
                const tagihanIdEdit = form.querySelector('#tagihan-id-edit').value;

                // Hanya isi otomatis jika dalam mode TAMBAH BARU (tidak ada tagihanIdEdit)
                if (tagihanIdEdit) {
                    Handlers.validateMeterAkhirVisual(); // Panggil validasi visual pada mode edit
                    return;
                }

                if (!pId) {
                    meterAwalInput.value = '';
                    Handlers.validateMeterAkhirVisual();
                    return;
                }

                // Refactoring: Gunakan State.getLatestTagihan
                const latestTagihan = State.getLatestTagihan(pId);

                const meterAwal = latestTagihan ? latestTagihan.meter_akhir : 0;
                meterAwalInput.value = meterAwal;
                // Meter awal sekarang bisa diedit manual karena atribut readonly sudah dihapus
                Handlers.validateMeterAkhirVisual();
            },
            
            // IMPROVEMENT: Real-time visual validation for Meter Akhir
            validateMeterAkhirVisual: () => {
                const form = UI.elements.formTagihan;
                const meterAwalInput = form.querySelector('#meter_awal');
                const meterAkhirInput = form.querySelector('#meter_akhir');
                const pId = form.querySelector('#select-pelanggan-tagihan').value;
                
                // Buat elemen visual feedback jika belum ada (atau ambil dari container baru)
                let feedback = UI.elements.meterAkhirFeedbackContainer.querySelector('#meter-akhir-feedback');
                if (!feedback) {
                    feedback = document.createElement('p');
                    feedback.id = 'meter-akhir-feedback';
                    feedback.style.marginTop = '5px';
                    feedback.style.fontWeight = 'bold';
                    UI.elements.meterAkhirFeedbackContainer.appendChild(feedback);
                }
                
                const mA = parseInt(meterAwalInput.value);
                const mAk = parseInt(meterAkhirInput.value);
                
                // Reset feedback
                feedback.textContent = '';
                feedback.className = '';
                feedback.style.color = 'var(--dark-color)';
                
                if (isNaN(mA) || isNaN(mAk) || mAk === 0) return;

                if (mAk < mA) {
                    feedback.textContent = '‚ùå Meter akhir lebih kecil dari meter awal!';
                    feedback.style.color = 'var(--danger-color)';
                    return;
                }

                const pemakaian = mAk - mA;
                
                // Lakukan pengecekan pemakaian wajar (copy logic dari saveMeterReading)
                const {max_usage_multiplier: MAX_USAGE_MULTIPLIER} = State.data.pengaturanAplikasi.biaya; 
                // Refactoring: Gunakan State.getLatestTagihan
                const lastTagihan = State.getLatestTagihan(pId);
                
                if (lastTagihan) {
                    const lastUsage = lastTagihan.pemakaian;
                    const baseUsage = lastUsage > 0 ? lastUsage : 10; 
                    const maxAllowedUsage = Math.round(baseUsage * MAX_USAGE_MULTIPLIER);

                    if (pemakaian > maxAllowedUsage) {
                        feedback.textContent = `‚ö†Ô∏è Pemakaian ${pemakaian} m¬≥. Terlalu tinggi! Maks wajar: ${maxAllowedUsage} m¬≥ (Faktor ${MAX_USAGE_MULTIPLIER}).`;
                        feedback.style.color = 'orange';
                        return;
                    }
                }
                
                feedback.textContent = `‚úÖ Pemakaian terhitung: ${pemakaian} m¬≥`;
                feedback.style.color = 'var(--success-color)';
            },
            
            saveTagihan(e) {
                e.preventDefault(); 
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Simpan Tagihan'); // Suggestion 5: Set loading state

                const form = UI.elements.formTagihan; const idEdit = form.querySelector('#tagihan-id-edit').value;
                const existing = idEdit ? State.data.tagihan.find(t => t.id === idEdit) : null;
                
                // Mode Edit Tanggal Bayar
                if (existing && existing.status === 'Lunas') {
                    const newTglBayar = form.querySelector('#tgl_bayar').value; 
                    if (!newTglBayar) { setButtonState(btn, false, 'Simpan Tagihan'); return UI.showToast('Tanggal bayar tidak boleh kosong!');}
                    
                    const kasEntry = State.data.kas.find(k => k.sumberTagihanId === existing.id && k.tipe === 'MASUK');
                    if(kasEntry) { State.updateKasEntry({ ...kasEntry, tanggal: newTglBayar }); }
                    State.updateTagihan({ ...existing, periodeBayar: newTglBayar }); 
                    
                    UI.showToast('Tanggal bayar berhasil diperbarui!');
                } 
                // Mode Edit/Lihat Tagihan Menunggu Validasi 
                else if (existing && existing.status === 'Menunggu Validasi') {
                    UI.closeAllModals(); 
                    return;
                }
                // Mode Tambah Baru/Edit Tagihan Belum Lunas
                else {
                    const pId = form.querySelector('#select-pelanggan-tagihan').value, 
                          mA = parseInt(form.querySelector('#meter_awal').value), 
                          mAk = parseInt(form.querySelector('#meter_akhir').value), 
                          per = form.querySelector('#periode_tagihan').value;
                    
                    if (!pId || !per || isNaN(mA) || isNaN(mAk)) { setButtonState(btn, false, 'Simpan Tagihan'); return UI.showToast('Semua kolom wajib diisi!');}
                    if (mAk < mA) { setButtonState(btn, false, 'Simpan Tagihan'); return UI.showToast('Meter akhir tidak boleh lebih kecil dari meter awal!');}
                    
                    // NEW VALIDATION: Check for excessive usage again on final submit
                    const {max_usage_multiplier: MAX_USAGE_MULTIPLIER} = State.data.pengaturanAplikasi.biaya; 
                    // Refactoring: Gunakan State.getLatestTagihan
                    const lastTagihan = State.getLatestTagihan(pId);
                    
                    if (lastTagihan) {
                        const lastUsage = lastTagihan.pemakaian;
                        const baseUsage = lastUsage > 0 ? lastUsage : 10; 
                        const maxAllowedUsage = Math.round(baseUsage * MAX_USAGE_MULTIPLIER);
                        const currentUsage = mAk - mA;
                        
                        if (currentUsage > maxAllowedUsage) {
                            if (!confirm(`Pemakaian (${currentUsage} m¬≥) terlalu tinggi (Maks wajar: ${maxAllowedUsage} m¬≥). Tetap simpan?`)) {
                                setButtonState(btn, false, 'Simpan Tagihan');
                                return;
                            }
                        }
                    }
                    // END NEW VALIDATION
                    
                    const p = State.data.pelanggan.find(pl => pl.id === pId);
                    if (!p) { setButtonState(btn, false, 'Simpan Tagihan'); return UI.showToast('Pelanggan tidak ditemukan!');}
                    
                    const g = State.data.golongan.find(gl => gl.id === p.golonganId); 
                    const { biaya } = State.data.pengaturanAplikasi;
                    if (!g) { setButtonState(btn, false, 'Simpan Tagihan'); return UI.showToast('Gagal menemukan tarif!');}
                    
                    const pem = mAk - mA; 
                    const bA = pem * g.tarif; 
                    const total = Utils.calculateTagihanTotal(bA, biaya.pemeliharaan, biaya.administrasi, 0);
                    const tData = { pelanggan_id: pId, periode: per, meter_awal: mA, meter_akhir: mAk, pemakaian: pem, biaya_air: bA, biaya_pemeliharaan: biaya.pemeliharaan, biaya_admin: biaya.administrasi, denda: 0, total_tagihan: total, sumber: 'staf' };
                    
                    if (existing) { 
                         // Check if meter_awal changes, if so, ensure meter_akhir is still >= meter_awal
                        if (mA > mAk) {
                            setButtonState(btn, false, 'Simpan Tagihan');
                            return UI.showToast('Meter akhir tidak boleh lebih kecil dari meter awal baru!');
                        }
                        State.updateTagihan({ ...existing, ...tData }); 
                        UI.showToast('Tagihan berhasil diperbarui!');
                    } else { 
                        if (State.data.tagihan.some(t => t.pelanggan_id === pId && t.periode === per)) { setButtonState(btn, false, 'Simpan Tagihan'); return UI.showToast('Tagihan untuk periode ini sudah ada!');}
                        // Tagihan staf tidak memiliki bukti foto
                        State.addTagihan({ id: Utils.generateId('tag'), ...tData, status: 'Belum Lunas' }); UI.showToast('Tagihan berhasil dibuat!'); 
                    }
                } 
                UI.closeAllModals();
                setButtonState(btn, false, 'Simpan Tagihan');
            },
            
            saveKasEntry(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Simpan Transaksi');

                const form = UI.elements.formKas;
                const idEdit = form.querySelector('#kas-id-edit').value;
                const tanggal = form.querySelector('#kas_tanggal').value;
                const tipe = form.querySelector('#kas_tipe').value;
                const deskripsi = form.querySelector('#kas_deskripsi').value.trim();
                const jumlah = parseInt(form.querySelector('#kas_jumlah').value);
                
                // NEW: Role check
                if (Auth.currentUser?.role !== 'full' && Auth.currentUser?.role !== 'keuangan') {
                    setButtonState(btn, false, 'Simpan Transaksi');
                    return UI.showToast('Akses ditolak. Hanya Admin dan Keuangan yang dapat menambah/mengubah Kas.');
                }


                if (!tanggal || !tipe || !deskripsi || isNaN(jumlah) || jumlah <= 0) {
                    setButtonState(btn, false, 'Simpan Transaksi');
                    return UI.showToast('Semua kolom wajib diisi dan Jumlah harus positif!');
                }

                const entryData = { id: idEdit || Utils.generateId('kas'), tanggal, tipe, deskripsi, jumlah, sumberTagihanId: undefined }; 
                
                if (idEdit) {
                    const existing = State.data.kas.find(k => k.id === idEdit);
                    if (existing && existing.sumberTagihanId) {
                         setButtonState(btn, false, 'Simpan Transaksi');
                         return UI.showToast('Tidak dapat mengedit transaksi pembayaran tagihan.');
                    }
                    State.updateKasEntry(entryData);
                    UI.showToast('Transaksi Kas diperbarui!');
                } else {
                    State.addKasEntry(entryData);
                    UI.showToast('Transaksi Kas ditambahkan!');
                }

                UI.closeAllModals();
                setButtonState(btn, false, 'Simpan Transaksi');
            },
            
            // TAMBAH: User Management Handlers
            saveUser(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Simpan User');
                
                // NEW: Role check
                if (Auth.currentUser?.role !== 'full') {
                    setButtonState(btn, false, 'Simpan User');
                    return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat menambah/mengubah User.');
                }

                const form = UI.elements.formUser;
                const idEdit = form.querySelector('#user-id-edit').value;
                const namaLengkap = form.querySelector('#user_nama_lengkap').value.trim();
                const username = form.querySelector('#user_username').value.trim();
                const password = form.querySelector('#user_password').value;
                const role = form.querySelector('#user_role').value;
                
                if (!namaLengkap || !username || (!idEdit && !password)) {
                    setButtonState(btn, false, 'Simpan User');
                    return UI.showToast('Nama Lengkap, Username, dan Password wajib diisi!');
                }
                
                if (!idEdit && State.data.users.some(u => u.username === username)) {
                    setButtonState(btn, false, 'Simpan User');
                    return UI.showToast('Username sudah ada!');
                }
                if (idEdit && State.data.users.some(u => u.username === username && u.id !== idEdit)) {
                    setButtonState(btn, false, 'Simpan User');
                    return UI.showToast('Username sudah digunakan user lain!');
                }

                if (idEdit) {
                    const existingUser = State.data.users.find(u => u.id === idEdit);
                    const userData = {
                        id: idEdit,
                        username: existingUser.username === 'admin' ? 'admin' : username, 
                        namaLengkap,
                        role: existingUser.username === 'admin' ? 'full' : role, // Admin utama tidak boleh ganti role
                        password: password || existingUser.password
                    };
                    State.updateUser(userData);
                    UI.showToast('User diperbarui!');
                } else {
                    const userData = {
                        id: Utils.generateId('usr'),
                        username,
                        namaLengkap,
                        role, 
                        password 
                    };
                    State.addUser(userData);
                    UI.showToast('User ditambahkan!');
                }
                UI.closeAllModals();
                setButtonState(btn, false, 'Simpan User');
            },
            userAction: (e) => {
                const {action, id} = e.target.dataset;
                if (!action) return;
                const user = State.data.users.find(u => u.id === id);
                if (!user) return;
                
                // NEW: Role check
                if (Auth.currentUser?.role !== 'full') {
                    return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat mengelola User.');
                }

                if (action === 'edit') {
                    UI.setupModalUser(user);
                } else if (action === 'delete') {
                    if (user.username === 'admin') {
                        return UI.showToast('User default "admin" tidak dapat dihapus!');
                    }
                    if(confirm(`Yakin hapus user ${user.username}?`)){
                        State.deleteUser(id);
                        UI.showToast('User dihapus.');
                    }
                }
            },
            // END: User Management Handlers
            
            // Logika Handler untuk tombol Edit/Hapus BKU
            kasAction: (e) => { 
                const {action, id}=e.target.dataset; 
                // Cek apakah yang diklik adalah tombol yang memiliki action
                if(e.target.closest('.action-buttons') && action) {
                    const kasEntry = State.data.kas.find(k => k.id === id); 
                    if (!kasEntry) return;
                    
                    // NEW: Role check
                    if (Auth.currentUser?.role !== 'full' && Auth.currentUser?.role !== 'keuangan') {
                        return UI.showToast('Akses ditolak. Hanya Admin dan Keuangan yang dapat mengelola Kas.');
                    }

                    if (action === 'edit') { 
                        // Pastikan bukan entry dari pembayaran tagihan
                        if (kasEntry.sumberTagihanId) return UI.showToast('Tidak dapat mengedit transaksi pembayaran tagihan.');
                        UI.setupModalKas(kasEntry); 
                    } else if (action === 'delete') { 
                        // Pastikan bukan entry dari pembayaran tagihan
                        if (kasEntry.sumberTagihanId) return UI.showToast('Tidak dapat menghapus transaksi pembayaran tagihan.');
                        if(confirm(`Yakin hapus transaksi kas tanggal ${Utils.formatDateID(kasEntry.tanggal)}: ${kasEntry.deskripsi}?`)){
                            State.deleteKasEntry(id);
                            UI.showToast('Transaksi Kas dihapus.');
                        }
                    } 
                }
            },
            
            // KAS UMUM HANDLERS (UPDATED)
            toggleKasUmumInput: () => { 
                const type = UI.elements.kasTipeFilter.value;
                const isB = type === 'bulanan'; 
                const isT = type === 'tahunan';
                const isR = type === 'rentang'; 

                UI.elements.kasBulanInput.style.display = isB ? 'block' : 'none'; 
                UI.elements.kasTahunInput.style.display = isT ? 'block' : 'none'; 
                UI.elements.kasFromInput.style.display = isR ? 'block' : 'none'; 
                UI.elements.kasToInput.style.display = isR ? 'block' : 'none';   
                
                // Pastikan Render.kasUmum hanya dipanggil jika Admin sudah login
                if(Auth.loggedAdmin) Render.kasUmum();
            },

            printKasUmum: () => {
                // NEW: Role check
                if (Auth.currentUser?.role !== 'full' && Auth.currentUser?.role !== 'keuangan') {
                    return UI.showToast('Akses ditolak. Hanya Admin dan Keuangan yang dapat mencetak BKU.');
                }
                
                const tableContent = document.getElementById('tabel-kas-umum').outerHTML;
                const filterType = UI.elements.kasTipeFilter.value;
                
                let filterPeriodText = 'Semua Periode';
                if (filterType === 'bulanan' && UI.elements.kasBulanInput.value) {
                    filterPeriodText = Utils.formatPeriode(UI.elements.kasBulanInput.value);
                } else if (filterType === 'tahunan' && UI.elements.kasTahunInput.value) {
                    filterPeriodText = `Tahun ${UI.elements.kasTahunInput.value}`;
                } else if (filterType === 'rentang' && UI.elements.kasFromInput.value && UI.elements.kasToInput.value) {
                    filterPeriodText = `Periode ${Utils.formatDateShort(UI.elements.kasFromInput.value)} s/d ${Utils.formatDateShort(UI.elements.kasToInput.value)}`;
                }

                const judul = filterType === 'semua' ? 'BUKU KAS UMUM KESELURUHAN' : `BUKU KAS UMUM ${filterPeriodText.toUpperCase()}`;

                const printArea = UI.elements.kasUmumPrintArea;
                printArea.innerHTML = `
                    <div style="text-align:center; margin-bottom: 20px;">
                        <h1 style="margin: 0;">${State.data.pengaturanAplikasi.judulAplikasi}</h1>
                        <h2 style="border: none; margin: 5px 0;">${judul}</h2>
                        <p>Tanggal Cetak: ${Utils.formatDateID(Utils.getTodayDate())}</p>
                        <p style="font-weight: bold;">SALDO AKHIR: ${UI.elements.statSaldoAkhir.textContent}</p>
                        <p>TOTAL MASUK: ${UI.elements.statKasMasuk.textContent} | TOTAL KELUAR: ${UI.elements.statKasKeluar.textContent}</p>
                    </div>
                    ${tableContent}
                `;
                // Hapus kolom Aksi dari tabel yang akan dicetak
                const tableToPrint = printArea.querySelector('#tabel-kas-umum');
                if (tableToPrint) {
                    // Hapus header Aksi
                    const thAksi = tableToPrint.querySelector('thead tr th:last-child');
                    if (thAksi && thAksi.textContent === 'Aksi') thAksi.remove();
                    
                    // Hapus kolom Aksi di setiap baris
                    tableToPrint.querySelectorAll('tbody tr').forEach(tr => {
                        const tdAksi = tr.querySelector('td:last-child');
                        if (tdAksi) tdAksi.remove();
                    });
                }
                
                Handlers.printContent('kas-umum-print-area', 'A4'); // Default to A4 for BKU
            },
            // END KAS UMUM HANDLERS

            // CUSTOMER HANDLERS
            handleCustomerLogin(e) { 
                e.preventDefault(); 
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Login'); // Suggestion 5: Set loading state
                
                const id = UI.elements.customerLoginForm.c_id.value.trim();
                const pin = UI.elements.customerLoginForm.c_pin.value.trim();
                
                setTimeout(() => Auth.loginCustomer(id, pin, btn), 500); 
            },
            handleCustomerNavigation(e) {
                e.preventDefault(); 
                const t = e.target.dataset.target; 
                UI.elements.customerNavLinks.forEach(l => l.classList.remove('active')); 
                UI.elements.customerContentSections.forEach(s => s.classList.remove('active')); 
                e.target.classList.add('active'); 
                document.getElementById(t).classList.add('active');
                if (t === 'riwayat-tagihan-pelanggan') Handlers.renderRiwayatTagihanPelanggan();
                else if (t === 'input-meter-mandiri') Handlers.renderCustomerPortal();
                // NEW: Handle Rekening Pembayaran
                else if (t === 'rekening-pembayaran') Render.rekeningPembayaran();
            },
            
            // UPDATED: Enhanced Visual Feedback (Suggestion 6)
            renderCustomerPortal() {
                const p = State.data.pelanggan.find(p => p.id === Auth.loggedCustomer);
                if (!p) return Auth.logoutCustomer();

                UI.elements.customerNameDisplay.textContent = p.nama;

                const currentPeriode = Utils.getCurrentPeriode();
                // Refactoring: Gunakan State.getLatestTagihan
                const lastTagihan = State.getLatestTagihan(p.id);
                const tagihanBulanIni = State.data.tagihan.find(t => t.pelanggan_id === p.id && t.periode === currentPeriode);

                if (tagihanBulanIni) {
                    UI.elements.formInputMeterMandiri.style.display = 'none';
                    // NEW VISUAL FEEDBACK (Suggestion 6)
                    if (tagihanBulanIni.status === 'Menunggu Validasi') {
                         UI.elements.meterInputStatus.innerHTML = `
                            <p class="status-pending" style="font-weight:bold;">‚úÖ Meteran Berhasil Diinput Mandiri</p>
                            <p>Periode: ${Utils.formatPeriode(currentPeriode)}</p>
                            <p style="font-size:1.1em;">
                                Mtr Awal: <strong class="status-pending">${tagihanBulanIni.meter_awal} m¬≥</strong> | 
                                Mtr Akhir: <strong class="status-pending">${tagihanBulanIni.meter_akhir} m¬≥</strong>
                            </p>
                            <p>Pemakaian Terhitung: <strong>${tagihanBulanIni.pemakaian} m¬≥</strong></p>
                            <p>Status: **MENUNGGU VALIDASI ADMIN**.</p>
                            <p><button class="btn btn-secondary" data-action="view-foto" data-id="${tagihanBulanIni.id}"><i class="fa-solid fa-camera" style="margin-right: 5px;"></i> Lihat Bukti Foto</button></p>
                         `;
                         // Gunakan event listener baru untuk tombol Lihat Foto di Portal Pelanggan
                         // Karena tombol ini dinamis, harus dilampirkan setelah di-render
                         const btnViewFoto = document.querySelector('#meter-input-status button[data-action="view-foto"]');
                         if(btnViewFoto) btnViewFoto.addEventListener('click', (e) => Handlers.tagihanAction.call(Handlers, { target: e.target }));
                    } else {
                         UI.elements.meterInputStatus.innerHTML = `<p class="status-lunas">Tagihan bulan ${Utils.formatPeriode(currentPeriode)} sudah terbentuk (${tagihanBulanIni.sumber === 'mandiri' ? 'Mandiri' : 'Staf'}). Total Tagihan: **${Utils.formatCurrency(tagihanBulanIni.total_tagihan)}**. Status: **${tagihanBulanIni.status}**.</p>`;
                    }
                } 
                else {
                    const meterAwal = lastTagihan ? lastTagihan.meter_akhir : 0;
                    UI.elements.periodeInputDisplay.textContent = Utils.formatPeriode(currentPeriode);
                    UI.elements.meterAwalC.value = meterAwal;
                    UI.elements.formInputMeterMandiri.style.display = 'block';
                    UI.elements.meterAkhirC.value = ''; 
                    // Clear file input
                    document.getElementById('bukti-validasi-foto').value = null;
                    UI.elements.meterInputStatus.innerHTML = `<p style="color:var(--primary-dark);">Silakan masukkan Meter Akhir Anda untuk periode **${Utils.formatPeriode(currentPeriode)}**. Meter Awal Anda saat ini adalah: **${meterAwal}**.</p>`;
                }
            },

            saveMeterReading(e) {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Simpan Pembacaan Meter'); // Suggestion 5: Set loading state

                const pId = Auth.loggedCustomer;
                const meterAwal = parseInt(UI.elements.meterAwalC.value);
                const meterAkhir = parseInt(UI.elements.meterAkhirC.value);
                const currentPeriode = Utils.getCurrentPeriode();
                const fotoInput = document.getElementById('bukti-validasi-foto');
                
                // UPDATED: Get multiplier from settings (Suggestion 4)
                const {max_usage_multiplier: MAX_USAGE_MULTIPLIER} = State.data.pengaturanAplikasi.biaya; 
                let maxMeterAkhirAllowed = meterAwal + 9999999; 

                // Dapatkan pemakaian bulan lalu untuk validasi wajar
                // Refactoring: Gunakan State.getLatestTagihan
                const lastTagihan = State.getLatestTagihan(pId);
                
                if (lastTagihan) {
                    const lastUsage = lastTagihan.pemakaian;
                    const baseUsage = lastUsage > 0 ? lastUsage : 10; 
                    const maxAllowedUsage = Math.round(baseUsage * MAX_USAGE_MULTIPLIER);
                    maxMeterAkhirAllowed = meterAwal + maxAllowedUsage;
                }


                if (isNaN(meterAkhir) || meterAkhir < meterAwal) {
                    setButtonState(btn, false, 'Simpan Pembacaan Meter');
                    return UI.showToast('Meter Akhir tidak valid atau lebih kecil dari Meter Awal!');
                }
                
                // VALIDASI BARU: Pemakaian berlebihan
                if (lastTagihan && meterAkhir > maxMeterAkhirAllowed) {
                    setButtonState(btn, false, 'Simpan Pembacaan Meter');
                    return UI.showToast(`Pemakaian tidak wajar (${meterAkhir - meterAwal} m¬≥)! Pemakaian maksimum yang diizinkan adalah sekitar ${maxMeterAkhirAllowed - meterAwal} m¬≥ (berdasarkan riwayat bulan lalu).`);
                }

                if (!fotoInput.files || fotoInput.files.length === 0) {
                    setButtonState(btn, false, 'Simpan Pembacaan Meter');
                    return UI.showToast('Wajib mengunggah bukti validasi foto!');
                }

                if (State.data.tagihan.some(t => t.pelanggan_id === pId && t.periode === currentPeriode)) {
                    setButtonState(btn, false, 'Simpan Pembacaan Meter');
                    return UI.showToast('Gagal: Tagihan untuk periode ini sudah ada!');
                }
                
                // NEW: Read file as Data URL to simulate file storage in localStorage
                const reader = new FileReader();
                reader.onload = function(event) {
                    const buktiFotoDataURL = event.target.result;
                    
                    const p = State.data.pelanggan.find(pl => pl.id === pId), g = State.data.golongan.find(gl => gl.id === p.golonganId), { biaya } = State.data.pengaturanAplikasi;
                    const pem = meterAkhir - meterAwal;
                    const bA = pem * g.tarif; 
                    const total = Utils.calculateTagihanTotal(bA, biaya.pemeliharaan, biaya.administrasi, 0);

                    const tData = { 
                        id: Utils.generateId('tag'), pelanggan_id: pId, periode: currentPeriode, meter_awal: meterAwal, meter_akhir: meterAkhir, pemakaian: pem, 
                        biaya_air: bA, biaya_pemeliharaan: biaya.pemeliharaan, biaya_admin: biaya.administrasi, denda: 0, 
                        total_tagihan: total, status: 'Menunggu Validasi', sumber: 'mandiri',
                        buktiFoto: buktiFotoDataURL // Simpan Data URL
                    };

                    State.addTagihan(tData);
                    UI.showToast(`Meteran berhasil diinput! Menunggu validasi admin.`);
                    
                    setButtonState(btn, false, 'Simpan Pembacaan Meter'); // Reset button state
                    Handlers.handleCustomerNavigation({ target: UI.elements.customerNavLinks[1], preventDefault: () => {} });
                };
                reader.readAsDataURL(fotoInput.files[0]);
            },

            // MODIFIKASI: Menambahkan tombol Aksi (Cetak)
            renderRiwayatTagihanPelanggan() {
                const pId = Auth.loggedCustomer;
                const tagihanCustomer = State.data.tagihan
                    .filter(t => t.pelanggan_id === pId)
                    .sort((a, b) => b.periode.localeCompare(a.periode));

                // UPDATE: Menambahkan Meter Awal, Meter Akhir, No. Pembayaran, dan Tombol Aksi
                UI.elements.tabelRiwayatTagihanPelanggan.innerHTML = tagihanCustomer.map(t => {
                    const statusClass = t.status === 'Lunas' ? 'status-lunas' : (t.status === 'Belum Lunas' ? 'status-belum' : 'status-pending');
                    
                    // LOGIC: Tambahkan tombol Cetak jika status LUNAS
                    let actionButton = '-';
                    if (t.status === 'Lunas') {
                         // Tambahkan class btn-sm agar tombol lebih kecil
                         actionButton = `<button class="btn btn-primary btn-sm" data-action="print" data-id="${t.id}"><i class="fa-solid fa-print"></i> Cetak</button>`;
                    }
                    
                    return `<tr>
                        <td>${t.status === 'Lunas' ? (t.no_pembayaran || 'N/A') : '-'}</td>
                        <td>${Utils.formatPeriode(t.periode)}</td>
                        <td>${t.meter_awal}</td>
                        <td>${t.meter_akhir}</td>
                        <td>${t.pemakaian}</td>
                        <td>${Utils.formatCurrency(t.total_tagihan)}</td>
                        <td class="${statusClass}">${t.status}</td>
                        <td>${t.periodeBayar ? Utils.formatDateID(t.periodeBayar) : '-'}</td>
                        <td class="action-buttons">${actionButton}</td> <!-- NEW ACTION COLUMN -->
                    </tr>`;
                }).join('');
                
                // Perbarui colspan menjadi 9 (8 kolom data + 1 kolom Aksi)
                if (tagihanCustomer.length === 0) {
                     UI.elements.tabelRiwayatTagihanPelanggan.innerHTML = '<tr><td colspan="9" class="empty-table-message">Belum ada riwayat tagihan.</td></tr>';
                }
            },
            
            // NEW HANDLER: Aksi tombol di riwayat tagihan pelanggan
            customerRiwayatAction: (e) => {
                // Pastikan yang diklik adalah tombol yang memiliki action
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                
                const {action, id} = btn.dataset;
                if (action === 'print') {
                    // Hanya izinkan mencetak tagihan yang sudah lunas
                    const tagihan = State.data.tagihan.find(t => t.id === id);
                    if (tagihan && tagihan.status === 'Lunas') {
                         // Reuse the existing admin print function
                         Handlers.handlePrintReceipt(id); 
                    } else {
                         UI.showToast('Hanya tagihan LUNAS yang dapat dicetak.');
                    }
                }
            },
            
            // NEW HANDLER: Upload Logo dan Preview (Diubah agar hanya tampilkan preview)
            uploadLogo: (e) => {
                const file = e.target.files[0];
                const preview = document.getElementById('preview-logo');
                
                // Reset temporary data
                delete UI.elements.btnSimpanLogo.dataset.tempBase64;
                
                if (!file) {
                    // Jika input file dikosongkan, tampilkan logo tersimpan atau kosong
                    preview.style.display = State.data.pengaturanAplikasi.logoBase64 ? 'block' : 'none';
                    preview.src = State.data.pengaturanAplikasi.logoBase64 || '';
                    return;
                }

                if (file.size > 500 * 1024) { // Batas 500KB
                    UI.showToast('Gagal! Ukuran file melebihi 500KB. File diabaikan.');
                    e.target.value = ''; // Reset input
                    preview.style.display = State.data.pengaturanAplikasi.logoBase64 ? 'block' : 'none';
                    preview.src = State.data.pengaturanAplikasi.logoBase64 || '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(event) {
                    const base64Data = event.target.result;
                    
                    // Tampilkan preview sementara
                    preview.src = base64Data;
                    preview.style.display = 'block';
                    UI.elements.btnSimpanLogo.dataset.tempBase64 = base64Data; // Simpan sementara di dataset tombol
                    
                    UI.showToast('File siap diunggah. Klik "Simpan Logo".');
                };
                reader.readAsDataURL(file);
            },
            
            // NEW HANDLER: Simpan Logo (dari data sementara)
            saveLogo: () => {
                const tempBase64 = UI.elements.btnSimpanLogo.dataset.tempBase64;
                const fileInput = UI.elements.inputLogoAplikasi;
                
                // Cek apakah ada data sementara
                if (tempBase64) {
                    // Simpan ke State dari data sementara
                    const newSettings = {...State.data.pengaturanAplikasi, logoBase64: tempBase64};
                    State.update({pengaturanAplikasi: newSettings});
                    
                    UI.showToast('Logo berhasil disimpan!');
                    fileInput.value = ''; // Clear file input
                    delete UI.elements.btnSimpanLogo.dataset.tempBase64; // Hapus data sementara
                } else if (State.data.pengaturanAplikasi.logoBase64) {
                    UI.showToast('Logo saat ini sudah tersimpan.');
                } else {
                    UI.showToast('Tidak ada file logo baru untuk disimpan.');
                }
            },
            
            // NEW HANDLER: Hapus Logo
            deleteLogo: () => {
                // Role check: Full Admin
                if (Auth.currentUser?.role !== 'full') return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat mengelola pengaturan.');

                if (!State.data.pengaturanAplikasi.logoBase64) {
                    return UI.showToast('Tidak ada logo tersimpan untuk dihapus.');
                }

                if (confirm('Yakin ingin menghapus logo? Logo struk akan kosong.')) {
                    const newSettings = {...State.data.pengaturanAplikasi, logoBase64: null};
                    State.update({pengaturanAplikasi: newSettings});
                    
                    // Bersihkan tampilan dan input
                    UI.elements.previewLogo.src = '';
                    UI.elements.previewLogo.style.display = 'none';
                    UI.elements.inputLogoAplikasi.value = '';
                    delete UI.elements.btnSimpanLogo.dataset.tempBase64;

                    UI.showToast('Logo berhasil dihapus.');
                }
            },
            
            // NEW HANDLER: Simpan Rekening Bank
            saveRekeningBank: (e) => {
                e.preventDefault();
                // Role check: Full Admin
                if (Auth.currentUser?.role !== 'full') return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat mengelola pengaturan.');
                
                const nB = UI.elements.inputNamaBank.value.trim();
                const nR = UI.elements.inputNomorRekening.value.trim();
                const nP = UI.elements.inputNamaPemilikRekening.value.trim();
                
                if (!nB || !nR || !nP) return UI.showToast('Semua kolom Rekening Bank wajib diisi.');
                
                const newRekening = { namaBank: nB, nomorRekening: nR, namaPemilikRekening: nP };
                const uS = { ...State.data.pengaturanAplikasi, rekeningBank: newRekening };
                State.update({ pengaturanAplikasi: uS });
                
                UI.showToast('Rekening Pembayaran berhasil disimpan.');
                Render.administrasi();
            },
            
            // --- INJECTED ADMIN HANDLERS (Adjusted) ---
            saveGolongan: (e) => { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); setButtonState(btn, true, 'Simpan'); const f = UI.elements.formGolongan, i = f.querySelector('#id_golongan'); const id = i.value.trim().toUpperCase(), n = f.querySelector('#nama_golongan').value.trim(), t = parseInt(f.querySelector('#tarif_golongan').value); if (!id || !n || isNaN(t) || t < 0) { setButtonState(btn, false, 'Simpan'); return UI.showToast('Semua kolom valid wajib diisi!');} if (!i.readOnly) { if (State.data.golongan.some(g => g.id === id)) { setButtonState(btn, false, 'Simpan'); return UI.showToast('ID Golongan sudah ada!');} State.addGolongan({ id, nama: n, tarif: t }); UI.showToast('Golongan ditambahkan!'); } else { State.updateGolongan({ id, nama: n, tarif: t }); UI.showToast('Golongan diperbarui!'); } UI.closeAllModals(); Render.golongan(); Render.pelanggan(); Render.tagihan(); setButtonState(btn, false, 'Simpan'); }, 
            // UPDATED: Include max_usage_multiplier (Suggestion 4)
            saveAdministrasi: (e) => { e.preventDefault(); const p=parseInt(document.getElementById('biaya-pemeliharaan').value), a=parseInt(document.getElementById('biaya-administrasi').value), d=parseInt(document.getElementById('biaya-denda').value); const m=parseFloat(document.getElementById('max-usage-multiplier').value); if(isNaN(p)||isNaN(a)||isNaN(d)||isNaN(m)||m<1) return UI.showToast('Semua biaya harus diisi dengan benar, dan Faktor Pemakaian Wajar minimal 1.0.'); const uS={...State.data.pengaturanAplikasi, biaya:{pemeliharaan:p,administrasi:a,denda:d, max_usage_multiplier:m}}; State.update({pengaturanAplikasi: uS}); UI.showToast('Biaya disimpan.'); },
            saveJudulAplikasi: () => { const nT=UI.elements.inputJudulAplikasi.value.trim(); if(!nT) return UI.showToast('Judul tidak boleh kosong.'); const uS={...State.data.pengaturanAplikasi, judulAplikasi:nT}; State.update({pengaturanAplikasi: uS}); UI.showToast('Judul diperbarui.'); },
            golonganAction: (e) => { const {action, id}=e.target.dataset; if(!action) return; if(action==='edit'){const g=State.data.golongan.find(gl=>gl.id===id);UI.setupModalGolongan(g);}else if(action==='delete'){if(State.data.pelanggan.some(p=>p.golonganId===id))return UI.showToast('Gagal! Golongan masih digunakan.');if(confirm(`Yakin hapus ${id}?`)){State.deleteGolongan(id);UI.showToast('Golongan dihapus.');}} Render.golongan(); Render.pelanggan(); Render.tagihan(); }, 
            pelangganAction: (e) => { const {action, id}=e.target.dataset; if(!action) return; if(action==='edit'){const p=State.data.pelanggan.find(pl=>pl.id===id);UI.setupModalPelanggan(State.data.golongan, p);}else if(action==='delete'){if(confirm('Yakin hapus pelanggan & tagihannya?')){State.deletePelanggan(id);UI.showToast('Pelanggan dihapus.');}} Render.pelanggan(); Render.tagihan(); }, 
            tagihanAction: (e) => {
                const {action, id}=e.target.dataset; if(!action) return;
                const tagihan = State.data.tagihan.find(t => t.id === id); if (!tagihan) return;
                
                // Get current user role safely
                const role = Auth.currentUser?.role;
                const isPetugas = role === 'petugas' || role === 'full';
                const isFullAdmin = role === 'full';
                
                // Cek apakah tombol ini berasal dari customer portal (tanpa Auth.currentUser)
                const isCustomerAction = !Auth.currentUser; 

                if (action === 'pay') { 
                    if (!isPetugas) return UI.showToast('Akses ditolak. Hanya Admin dan Petugas yang dapat melakukan pembayaran.');
                    if (tagihan.status === 'Menunggu Validasi') return UI.showToast('Tagihan Mandiri harus divalidasi Admin dahulu!');
                    UI.setupModalPembayaran(tagihan); 
                }
                else if (action === 'edit') { 
                    // Tombol edit di tagihan: Jika Lunas -> Edit Tgl Bayar (Full Admin). Jika Belum Lunas -> Edit Meter (Petugas/Full). Jika Validasi -> Lihat (Semua Admin).
                    if (tagihan.status === 'Lunas' && !isFullAdmin) return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat mengedit tanggal pembayaran.');
                    if (tagihan.status !== 'Lunas' && !isPetugas) return UI.showToast('Akses ditolak. Hanya Admin dan Petugas yang dapat mengedit tagihan.');
                    UI.setupModalTagihan(State.data.pelanggan, tagihan); 
                }
                else if (action === 'validate') { // NEW ACTION
                    if (!isPetugas) return UI.showToast('Akses ditolak. Hanya Admin dan Petugas yang dapat memvalidasi.');
                    if(confirm('Yakin memvalidasi dan menjadikan tagihan ini siap dibayar?')){ 
                        State.validateTagihan(id); 
                        UI.showToast('Tagihan divalidasi dan siap dibayar.'); 
                    }
                }
                else if (action === 'view-foto') { // NEW ACTION
                    const p = State.data.pelanggan.find(pl => pl.id === tagihan.pelanggan_id);
                    document.getElementById('foto-pelanggan-info').textContent = p.nama;
                    document.getElementById('foto-periode-info').textContent = Utils.formatPeriode(tagihan.periode);
                    document.getElementById('bukti-foto-display').src = tagihan.buktiFoto;
                    UI.openModal(document.getElementById('modal-bukti-foto'));
                }
                else if (action === 'delete') { 
                    if (!isPetugas) return UI.showToast('Akses ditolak. Hanya Admin dan Petugas yang dapat menghapus tagihan.');
                    if(confirm('Yakin hapus tagihan?')){ 
                    if(tagihan.status === 'Lunas') { 
                        return UI.showToast('Gagal! Batalkan pembayaran dahulu sebelum menghapus tagihan yang sudah lunas.');
                    }
                    State.deleteTagihan(id); 
                    UI.showToast('Tagihan dihapus.'); 
                }}
                else if (action === 'print') { Handlers.handlePrintReceipt(id); }
                else if (action === 'cancel-pay') { 
                    if (!isFullAdmin) return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat membatalkan pembayaran.');
                    if(confirm('Yakin batalkan pembayaran?')){ 
                        State.cancelPayment(id); 
                        UI.showToast('Pembayaran dibatalkan.'); 
                    }
                }
                Render.tagihan(); 
                Render.dashboard();
            },
            konfirmasiPembayaran: (e) => {
                e.preventDefault(); 
                const btn = e.target.querySelector('button[type="submit"]');
                setButtonState(btn, true, 'Konfirmasi Bayar');
                
                // Role check: Petugas / Full Admin
                if (Auth.currentUser?.role !== 'full' && Auth.currentUser?.role !== 'petugas') { setButtonState(btn, false, 'Konfirmasi Bayar'); return UI.showToast('Akses ditolak. Hanya Admin dan Petugas yang dapat melakukan pembayaran.'); }


                const tagihanId = document.getElementById('bayar-tagihan-id').value; 
                const tagihan = State.data.tagihan.find(t => t.id === tagihanId);
                
                if (tagihan.status === 'Menunggu Validasi') { setButtonState(btn, false, 'Konfirmasi Bayar'); return UI.showToast('Gagal: Tagihan Mandiri harus divalidasi Admin dahulu!'); }

                const [y, m] = tagihan.periode.split('-'); 
                const tglJatuhTempo = new Date(parseInt(y), parseInt(m), 1); 
                tglJatuhTempo.setMonth(tglJatuhTempo.getMonth() + 1); // Jatuh tempo tanggal 1 bulan berikutnya
                const tglSekarang = new Date(); 
                let withDenda = false;
                
                if (tglSekarang.getTime() > tglJatuhTempo.getTime()) { 
                    if(confirm(`Tagihan untuk periode ${Utils.formatPeriode(tagihan.periode)} sudah lewat jatuh tempo. Terapkan denda ${Utils.formatCurrency(State.data.pengaturanAplikasi.biaya.denda)}?`)) { 
                        withDenda = true; 
                    } 
                }
                
                State.payTagihan(tagihanId, withDenda);
                
                const updatedTagihan = State.data.tagihan.find(t => t.id === tagihanId);
                const totalTagihan = updatedTagihan.total_tagihan;

                const jumlahBayar = parseFloat(document.getElementById('jumlah-uang-bayar').value);
                const kembalian = jumlahBayar - totalTagihan;

                UI.showToast(`Pembayaran Lunas! Kembalian: ${Utils.formatCurrency(kembalian)}`);
                UI.closeAllModals(); 
                
                Render.dashboard(); 
                Render.tagihan(); 
                Render.kasUmum(); 
                if(UI.elements.bayarSearchPelanggan.value.trim() !== '') Handlers.findBillsForPayment(); 
            },
            hitungKembalian: () => {
                const totalTagihan = parseFloat(document.getElementById('bayar-total-tagihan').dataset.total);
                const jumlahBayar = parseFloat(document.getElementById('jumlah-uang-bayar').value) || 0;
                const kembalianDisplay = document.getElementById('kembalian-display');
                const btnKonfirmasi = document.getElementById('btn-konfirmasi-pembayaran');
                if (jumlahBayar >= totalTagihan) { const kembalian = jumlahBayar - totalTagihan; kembalianDisplay.textContent = Utils.formatCurrency(kembalian); kembalianDisplay.classList.replace('status-belum', 'status-lunas'); btnKonfirmasi.disabled = false;
                } else { kembalianDisplay.textContent = 'Uang Kurang'; kembalianDisplay.classList.replace('status-lunas', 'status-belum'); btnKonfirmasi.disabled = true; }
            },
            findBillsForPayment: () => { 
                const id=UI.elements.bayarSearchPelanggan.value.trim(); 
                if(!id) return UI.showToast('Masukkan nomor pelanggan!'); 
                const c=State.data.pelanggan.find(p=>p.id===id); 
                // Cari tagihan Belum Lunas dan Menunggu Validasi
                const bills=c?State.data.tagihan.filter(t=>t.pelanggan_id===id&&(t.status==='Belum Lunas'||t.status==='Menunggu Validasi')): []; 
                Render.inputBayarResults(c,bills); 
            },
            resetInputBayar: () => { UI.elements.bayarSearchPelanggan.value=''; const r=UI.elements.bayarHasilPencarian; r.style.display='none'; r.innerHTML=''; },
            
            
            // PERBAIKAN FUNGSI PRINT: Menggunakan window.print() langsung pada elemen yang di-set khusus
            printContent: (elementId, paperSizeClass = '') => {
                const contentArea = document.getElementById(elementId);
                
                // 1. Tambahkan class ke <body> untuk mengaktifkan mode print khusus
                document.body.classList.add('is-printing'); 
                
                // 2. Tambahkan class khusus yang akan di-display di media print 
                contentArea.classList.add('print-only-container', paperSizeClass);
                
                // 3. Tambahkan display:block inline agar elemen muncul di DOM sebelum print dipanggil
                contentArea.style.display = 'block'; 

                // 4. Panggil fungsi print bawaan browser
                window.print();
                
                // 5. Setelah selesai (atau setelah waktu tunggu singkat) kembalikan tampilan normal
                setTimeout(() => { 
                    contentArea.classList.remove('print-only-container', paperSizeClass);
                    contentArea.style.display = 'none'; // Sembunyikan kembali
                    document.body.classList.remove('is-printing'); // Hapus class dari <body>
                }, 100); 
            },
            
            // MODIFIKASI: MENAMPILKAN NO REK DI BUKTI PEMBAYARAN
            handlePrintReceipt: (id) => {
                const t = State.data.tagihan.find(tg => tg.id === id); if (!t) return UI.showToast('Tagihan tidak ditemukan.');
                const p = State.data.pelanggan.find(pl => pl.id === t.pelanggan_id); 
                const g = State.data.golongan.find(gl => gl.id === p.golonganId); 
                if (!p || !g) return UI.showToast('Data pelanggan/golongan tidak lengkap.');
                
                // NEW: Ambil data Rekening Bank
                const rekening = State.data.pengaturanAplikasi.rekeningBank || {};
                
                // Tentukan alamat kantor (dihilangkan dari output cetak)
                const kantorAddress = ""; 

                // NEW: Ambil Logo Base64
                const logo = State.data.pengaturanAplikasi.logoBase64;
                const logoHtml = logo ? `<img src="${logo}" alt="Logo Aplikasi" style="max-width: 50px; max-height: 50px; margin-right: 10px;">` : '';
                
                // NEW: Konten Rekening Bank
                const rekeningHtml = rekening.nomorRekening ? `
                    <div style="margin-top: 15px; padding: 5px 0; border-top: 1px dashed #000; border-bottom: 1px dashed #000; text-align: center; font-size: 10pt;">
                        <p style="margin: 0; font-weight: bold;">Pembayaran Transfer ke Rekening:</p>
                        <p style="margin: 3px 0; font-size: 12pt; font-weight: bold;">${rekening.namaBank} - ${rekening.nomorRekening}</p>
                        <p style="margin: 0;">A.N. ${rekening.namaPemilikRekening}</p>
                    </div>
                ` : '';

                const receiptHtml = `
                    <div class="receipt-print-container">
                        <!-- HEADER/INFORMASI TAGIHAN -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px;">
                            <div style="display: flex; align-items: center;">
                                ${logoHtml} <!-- LOGO DITEMPATKAN DI SINI -->
                                <div style="font-size:14px;font-weight:bold;">${State.data.pengaturanAplikasi.judulAplikasi.toUpperCase()}</div>
                            </div>
                            <div style="font-size:16px;font-weight:bold; color: #000; text-align: right;">BUKTI PEMBAYARAN AIR</div>
                        </div>

                        <!-- KEPADA YTH DAN DETAIL TAGIHAN (Dibuat Grid 2 Kolom) -->
                        <div class="detail-info-grid" style="margin-bottom: 10px;">
                            <div style="width: 50%;">
                                <div style="font-weight: bold; margin-bottom: 5px; font-size: 10pt;">Kepada Yth:</div>
                                <!-- NAMA PELANGGAN TERISI DI SINI -->
                                <div style="font-size: 11pt; font-weight: bold; margin-bottom: 5px;">${p.nama.toUpperCase()}</div>
                                <!-- Baris alamat kantor dihilangkan sepenuhnya -->
                                <div style="font-size: 10pt;">${p.alamat}</div>
                            </div>
                            <div style="width: 50%; font-size: 10pt;">
                                <!-- MODIFIKASI 2: Buat alignment sejajar (:) untuk detail atas -->
                                <div class="detail-row" style="display: block;">
                                    <span style="display: inline-block; width: 120px;">ID Pelanggan</span>: <span>${p.id}</span>
                                </div>
                                <div class="detail-row" style="display: block;">
                                    <span style="display: inline-block; width: 120px;">Periode Tagihan</span>: <span>${Utils.formatPeriode(t.periode)}</span>
                                </div>
                                <div class="detail-row" style="display: block;">
                                    <span style="display: inline-block; width: 120px;">Tgl Bayar</span>: <span>${t.periodeBayar ? Utils.formatDateID(t.periodeBayar) : '-'}</span>
                                </div>
                                <div class="detail-row" style="display: block;">
                                    <span style="display: inline-block; width: 120px;">No. Pembayaran</span>: <span>${t.no_pembayaran || 'N/A'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- GARIS PEMISAH -->
                        <div style="margin:5px 0;border-top:1px dashed #000;"></div>

                        <!-- TABEL METERAN (Disusun ulang seperti di gambar) -->
                        <table class="meter-table">
                            <thead>
                                <tr>
                                    <th>Catatan Meter</th>
                                    <th>Tanggal</th>
                                    <th>Meter Awal</th>
                                    <th>Meter Akhir</th>
                                    <th>Pemakaian (m¬≥)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Pembacaan</td>
                                    <td>${Utils.formatDateShort(t.periode + '-01')}</td>
                                    <td>${t.meter_awal}</td>
                                    <td>${t.meter_akhir}</td>
                                    <td>${t.pemakaian}</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- GARIS PEMISAH -->
                        <div style="margin:5px 0;border-top:1px dashed #000;"></div>

                        <!-- RINCIAN BIAYA (Dibuat Grid 2 Kolom dengan alignment rapi, Rata Kiri-Kanan) -->
                        <div style="font-size: 12pt; font-weight: bold; text-align: center; margin-bottom: 5px;">RINCIAN BIAYA</div>
                        <div class="detail-info-grid" style="font-size: 12pt; padding: 5px 0;">
                            <div style="width: 50%;"> <!-- Diberi width 50% untuk mensejajarkan dengan yang kanan -->
                                <div class="detail-row"><span>Biaya Air (Pemakaian ${t.pemakaian} m¬≥)</span><span style="text-align: right;">${Utils.formatCurrency(t.biaya_air)}</span></div>
                                <div class="detail-row"><span>Biaya Pemeliharaan</span><span style="text-align: right;">${Utils.formatCurrency(t.biaya_pemeliharaan)}</span></div>
                                <div class="detail-row"><span>Biaya Administrasi</span><span style="text-align: right;">${Utils.formatCurrency(t.biaya_admin)}</span></div>
                                ${t.denda > 0 ? `<div class="detail-row"><span>Denda Keterlambatan</span><span style="color:var(--danger-color); text-align: right;">${Utils.formatCurrency(t.denda)}</span></div>` : ''}
                            </div>
                            <div style="width: 45%; font-size: 10pt; text-align: right;"> <!-- Diberi width 45% agar ada sedikit jarak dan rata kanan -->
                                <!-- MODIFIKASI 2: Buat alignment sejajar (:) untuk detail golongan -->
                                <div class="detail-row" style="display: block;">
                                    <span style="display: inline-block; width: 100px;">Golongan</span>: <span>${g.id} (${g.nama})</span>
                                </div>
                                <div class="detail-row" style="display: block;">
                                    <span style="display: inline-block; width: 100px;">Tarif Dasar</span>: <span>${Utils.formatCurrency(g.tarif)}/m¬≥</span>
                                </div>
                            </div>
                        </div>

                        <!-- GARIS PEMISAH -->
                        <div style="margin:5px 0;border-top:1px dashed #000;"></div>

                        <!-- TOTAL TAGIHAN -->
                        <div style="display: flex; justify-content: flex-end; align-items: center; text-align: right;">
                            <div style="width: 50%;">
                                <div class="total-tagihan-row">
                                    <span>TOTAL TAGIHAN:</span>
                                    <span>${Utils.formatCurrency(t.total_tagihan)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NEW: TAMPILKAN REKENING BANK JIKA ADA -->
                        ${rekeningHtml}

                        <!-- CATATAN KAKI -->
                        <div style="margin-top:15px; font-size:10pt; text-align:center;">
                            <p style="margin: 0;">LUNAS. Terima Kasih atas pembayaran Anda.</p>
                            <p style="margin: 5px 0 0 0;">Simpan Bukti ini sebagai Bukti yang Sah.</p>
                            <!-- MODIFIKASI 3: Tambahkan Footer Khusus -->
                            <p style="margin: 5px 0 0 0; font-style: italic; font-weight: bold;"> di cetak menggunakan Sistem Tagihan Air Pamsimas Gusi</p> 
                        </div>
                    </div>
                `;
                document.getElementById('bukti-bayar-area').innerHTML = receiptHtml;
                Handlers.printContent('bukti-bayar-area', 'receipt'); 
            },
            
            // IMPROVEMENT: Implement exportData function
            exportData: () => {
                // Role check: Full Admin
                if (Auth.currentUser?.role !== 'full') return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat melakukan export/import.');
                
                try {
                    const dataToExport = State.data;
                    const dataStr = JSON.stringify(dataToExport, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    // Memberi nama file yang informatif
                    a.download = `backup_tagihan_air_${new Date().toISOString().slice(0, 10)}.json`;
                    
                    // Simulasikan klik link untuk mendownload
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    UI.showToast('Data berhasil diekspor!');
                } catch (error) {
                    console.error("Export failed:", error);
                    UI.showToast('Gagal mengekspor data.');
                }
            },
            
            // PERBAIKAN SINTAKSIS PADA BLOK TRY...CATCH (yang dilaporkan error)
            importData: (e) => { 
                // Role check: Full Admin
                if (Auth.currentUser?.role !== 'full') { e.target.value = ''; return UI.showToast('Akses ditolak. Hanya Admin Penuh yang dapat melakukan export/import.'); }
                
                const f = e.target.files[0]; 
                if (!f) return; 
                const r = new FileReader(); 
                
                r.onload = (ev) => {
                    let importedData;
                    try {
                        importedData = JSON.parse(ev.target.result);
                    } catch (err) {
                        UI.showToast('Gagal membaca file (bukan format JSON yang valid).');
                        return;
                    }
                    
                    // Cek keberadaan properti utama
                    if (importedData.pelanggan && importedData.tagihan && importedData.golongan && importedData.pengaturanAplikasi) {
                        if (confirm('Ini akan menimpa semua data. Lanjutkan?')) {
                            // PERBAIKAN: Perlu memanggil State.update dengan data yang diimpor
                            State.update(importedData);
                            UI.showToast('Data diimpor!');
                        }
                    } else {
                        UI.showToast('Format file tidak valid. File JSON tidak mengandung struktur data aplikasi.');
                    }
                }; 
                
                r.readAsText(f); 
                e.target.value = ''; // Reset input file
            },
        };
        
        const App = {
            init() { 
                // TAMBAH: Sembunyikan semua kecuali splash
                UI.elements.loginScreen.style.display = 'none';
                UI.elements.mainApp.style.display = 'none';
                UI.elements.customerLoginScreen.style.display = 'none';
                UI.elements.customerApp.style.display = 'none';
                
                // TAMBAH: Tampilkan splash screen
                UI.elements.splashScreen.style.opacity = '1';
                UI.elements.splashScreen.style.display = 'flex';
                
                // Deteksi apakah data sudah ada sebelum load (untuk pesan "data baru dibuat")
                const isFreshStart = !localStorage.getItem('appData');
                
                // Load data dan tunggu sebentar untuk efek splash screen
                State.load(); 
                this.setDefaultLaporanDate(); 
                
                setTimeout(() => {
                    UI.elements.splashScreen.style.opacity = '0';
                    setTimeout(() => {
                        UI.elements.splashScreen.style.display = 'none';
                        // NEW: Tampilkan toast jika data default baru dibuat
                        if (isFreshStart) {
                            UI.showToast('Memuat data default. Data aplikasi baru dibuat.');
                        }
                        this.bindEvents(); 
                        Auth.checkLogin(); 
                        Handlers.toggleKasUmumInput(); // Panggil di sini agar elemen filter ter-toggle setelah login admin terdeteksi/gagal.
                    }, 500); // 500ms for fade out animation
                }, 1500); // Tampilkan splash screen selama 1.5 detik
            },
            bindEvents() {
                const { elements: el } = UI;
                
                // GLOBAL LOGIN/LOGOUT
                document.getElementById('btn-go-to-customer').addEventListener('click', () => UI.showCustomerLoginScreen());
                document.getElementById('btn-back-to-admin').addEventListener('click', () => UI.showAdminLoginScreen());
                el.loginForm.addEventListener('submit', Handlers.loginSubmit); 
                el.customerLoginForm.addEventListener('submit', Handlers.handleCustomerLogin); 
                el.btnLogout.addEventListener('click', Auth.logoutAdmin); 
                document.getElementById('btn-customer-logout').addEventListener('click', Auth.logoutCustomer);

                // ADMIN APP EVENTS
                el.navLinks.forEach(link => link.addEventListener('click', Handlers.navigation));
                el.formPelanggan.addEventListener('submit', Handlers.savePelanggan);
                el.formTagihan.addEventListener('submit', Handlers.saveTagihan);
                document.getElementById('btn-tambah-golongan').addEventListener('click', () => UI.setupModalGolongan());
                document.getElementById('btn-tambah-pelanggan').addEventListener('click', () => UI.setupModalPelanggan(State.data.golongan));
                document.getElementById('btn-buat-tagihan').addEventListener('click', () => UI.setupModalTagihan(State.data.pelanggan));
                el.tabelGolonganBody.addEventListener('click', Handlers.golonganAction); 
                el.tabelPelangganBody.addEventListener('click', Handlers.pelangganAction); 
                // FIX: Add call(Handlers, e) to ensure 'this' context is correct inside Handlers methods if needed
                el.tabelTagihanBody.addEventListener('click', (e) => Handlers.tagihanAction.call(Handlers, e)); 
                el.searchPelanggan.addEventListener('input', () => Render.pelanggan()); 
                
                // NEW: Bind events for tagihan filters
                el.filterTagihanStatus.addEventListener('change', () => Render.tagihan());
                el.filterTagihanBulan.addEventListener('change', () => Render.tagihan());
                el.filterTagihanTahun.addEventListener('change', () => { 
                    el.filterTagihanBulan.value = ''; // Clear month if year is changed
                    Render.tagihan(); 
                });
                
                // FIX/IMPROVEMENT: Add event listener for auto-fill meter awal & real-time validation
                el.selectPelangganTagihan.addEventListener('change', Handlers.setupTagihanMeterAutoFill); 
                document.getElementById('meter_akhir').addEventListener('input', Handlers.validateMeterAkhirVisual); // IMPROVEMENT #2
                
                // Kas Umum Events
                document.getElementById('btn-tambah-kas').addEventListener('click', () => UI.setupModalKas());
                el.formKas.addEventListener('submit', Handlers.saveKasEntry);
                // Tambahkan event listener untuk aksi edit/hapus BKU
                el.tabelKasUmumBody.addEventListener('click', (e) => Handlers.kasAction.call(Handlers, e));
                
                // BKU Filter/Print Events
                el.kasTipeFilter.addEventListener('change', Handlers.toggleKasUmumInput);
                el.kasBulanInput.addEventListener('change', () => Render.kasUmum());
                el.kasTahunInput.addEventListener('change', () => Render.kasUmum());
                el.kasFromInput.addEventListener('change', () => Render.kasUmum()); 
                el.kasToInput.addEventListener('change', () => Render.kasUmum());   
                el.btnCetakKasUmum.addEventListener('click', Handlers.printKasUmum);
                // END BKU Events
                
                // TAMBAH: User Management Events
                document.getElementById('btn-tambah-user').addEventListener('click', () => UI.setupModalUser());
                el.formUser.addEventListener('submit', Handlers.saveUser);
                el.tabelUserBody.addEventListener('click', Handlers.userAction);
                // END: User Management Events


                // CUSTOMER APP EVENTS
                el.customerNavLinks.forEach(link => link.addEventListener('click', Handlers.handleCustomerNavigation));
                el.formInputMeterMandiri.addEventListener('submit', Handlers.saveMeterReading);
                // NEW: Binding event untuk tombol aksi (Cetak) di riwayat tagihan pelanggan
                document.getElementById('tabel-riwayat-tagihan-pelanggan').addEventListener('click', Handlers.customerRiwayatAction);


                // MODAL/GLOBAL
                el.closeButtons.forEach(btn => btn.addEventListener('click', () => UI.closeAllModals()));
                window.addEventListener('click', e => { if (e.target.classList.contains('modal')) UI.closeAllModals() });
                
                el.formGolongan.addEventListener('submit', Handlers.saveGolongan);
                el.formAdministrasi.addEventListener('submit', Handlers.saveAdministrasi);
                el.btnSimpanJudul.addEventListener('click', Handlers.saveJudulAplikasi);
                
                // NEW: Binding Event Simpan Rekening Bank
                el.formRekeningBank.addEventListener('submit', Handlers.saveRekeningBank);
                
                // FIX: Use tagihanAction for buttons inside bayarHasilPencarian
                el.bayarHasilPencarian.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (btn && btn.dataset.action) {
                         Handlers.tagihanAction.call(Handlers, { target: btn });
                    }
                });
                el.btnCariTagihan.addEventListener('click', Handlers.findBillsForPayment);
                el.formPembayaran.addEventListener('submit', (e) => Handlers.konfirmasiPembayaran.call(Handlers, e));
                el.formPembayaran.querySelector('#jumlah-uang-bayar').addEventListener('input', Handlers.hitungKembalian);
                
                el.btnExport.addEventListener('click', Handlers.exportData); // IMPROVEMENT #1
                el.importFile.addEventListener('change', Handlers.importData);

                // NEW: Binding Event untuk Upload Logo
                el.inputLogoAplikasi.addEventListener('change', Handlers.uploadLogo);
                el.btnSimpanLogo.addEventListener('click', Handlers.saveLogo);   // NEW BINDING
                el.btnHapusLogo.addEventListener('click', Handlers.deleteLogo);   // NEW BINDING
            },
            setDefaultLaporanDate() { 
                const n = new Date(); 
                const currentPeriode = Utils.getCurrentPeriode();
                const currentYear = n.getFullYear();
                
                // Set default for Kas Umum
                UI.elements.kasBulanInput.value = currentPeriode;
                UI.elements.kasTahunInput.value = currentYear;
                UI.elements.kasFromInput.value = Utils.getPrevMonth(currentPeriode) + '-01'; 
                UI.elements.kasToInput.value = Utils.getTodayDate();                        
                
                // Set default for Tagihan Filter (default to current month)
                UI.elements.filterTagihanBulan.value = currentPeriode;
                UI.elements.filterTagihanTahun.value = currentYear;
            },
            render() { Render.all(); }
        };
        
        App.init();
    });
</script>
</body>
</html>
